{% extends "layout.html" %}

{% block title %}{{ 'ç·¨è¼¯ç§Ÿæˆ¶' if is_edit else 'æ–°å¢ç§Ÿæˆ¶' }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1>
        <i data-lucide="{{ 'edit-2' if is_edit else 'plus-circle' }}"
            style="width: 24px; height: 24px; margin-right: 8px;"></i>
        {{ 'ç·¨è¼¯ç§Ÿæˆ¶' if is_edit else 'æ–°å¢ç§Ÿæˆ¶' }}
    </h1>
    <a href="{{ url_for('admin.list_tenants') }}" class="btn btn-secondary">
        <i data-lucide="arrow-left" style="width: 16px; height: 16px;"></i>
        è¿”å›åˆ—è¡¨
    </a>
</div>

<div class="card">
    <form id="tenant-form" method="POST"
        action="{{ url_for('admin.edit_tenant', tenant_id=tenant.id) if is_edit else url_for('admin.create_tenant') }}">

        <!-- Basic Info -->
        <h2>
            <i data-lucide="info" style="width: 16px; height: 16px; margin-right: 8px; vertical-align: middle;"></i>
            åŸºæœ¬è³‡è¨Š
        </h2>

        <div class="form-group">
            <label for="name">ç§Ÿæˆ¶åç¨± *</label>
            <input type="text" id="name" name="name" value="{{ tenant.name if tenant else '' }}" required
                placeholder="ä¾‹å¦‚ï¼šå°æ˜çš„åç‰‡Bot">
            <small>é¡¯ç¤ºåœ¨ç®¡ç†å¾Œå°çš„åç¨±</small>
        </div>

        {% if is_edit %}
        <div class="form-group">
            <label>è­˜åˆ¥ç¢¼ (Slug)</label>
            <input type="text" value="{{ tenant.slug }}" disabled style="opacity: 0.6;">
            <small>å»ºç«‹å¾Œç„¡æ³•ä¿®æ”¹</small>
        </div>

        <div class="form-group form-check">
            <input type="checkbox" id="is_active" name="is_active" {{ 'checked' if tenant.is_active else '' }}>
            <label for="is_active">å•Ÿç”¨ç§Ÿæˆ¶</label>
        </div>
        {% else %}
        <div class="form-group">
            <label for="slug">è­˜åˆ¥ç¢¼ (Slug)</label>
            <input type="text" id="slug" name="slug" value="" placeholder="è‡ªå‹•ç”¢ç”Ÿ">
            <small>URL å‹å–„çš„è­˜åˆ¥ç¢¼ï¼Œç•™ç©ºå°‡è‡ªå‹•ç”¢ç”Ÿ</small>
        </div>
        {% endif %}

        <!-- LINE Bot Config -->
        <h2 style="margin-top: 30px;">
            <i data-lucide="message-circle"
                style="width: 16px; height: 16px; margin-right: 8px; vertical-align: middle;"></i>
            LINE Bot è¨­å®š
        </h2>

        <div class="form-group">
            <label for="line_channel_access_token">Channel Access Token *</label>
            <input type="password" id="line_channel_access_token" name="line_channel_access_token" {{ 'required' if not
                is_edit else '' }} placeholder="{{ 'å·²è¨­å®š (ç•™ç©ºä¿æŒä¸è®Š)' if is_edit else 'åœ¨ LINE Developers Console å–å¾—' }}">
            <small>Messaging API â†’ Channel access token (long-lived)</small>
        </div>

        <div class="form-group">
            <label for="line_channel_secret">Channel Secret *</label>
            <input type="password" id="line_channel_secret" name="line_channel_secret" {{ 'required' if not is_edit
                else '' }} placeholder="{{ 'å·²è¨­å®š (ç•™ç©ºä¿æŒä¸è®Š)' if is_edit else 'åœ¨ LINE Developers Console å–å¾—' }}">
            <small>Messaging API â†’ Channel secret</small>
        </div>

        {% if not is_edit %}
        <!-- ç²å– Bot User ID æŒ‰éˆ• -->
        <div class="form-group">
            <button type="button" id="fetch-bot-id-btn" class="btn btn-secondary" onclick="fetchBotUserId()"
                style="margin-bottom: 10px;">
                <i data-lucide="search" style="width: 16px; height: 16px;"></i>
                ç²å– Bot User ID
            </button>
            <div id="fetch-status" style="display: none; padding: 10px; border-radius: 6px; margin-top: 10px;"></div>
        </div>
        {% endif %}

        <div class="form-group">
            <label for="line_channel_id">LINE Bot User ID {{ '*' if not is_edit else '' }}</label>
            <input type="text" id="line_channel_id" name="line_channel_id"
                value="{{ tenant.line_channel_id if tenant and tenant.line_channel_id else '' }}" {{ 'readonly' if not
                is_edit else '' }}
                placeholder="{{ (tenant.line_channel_id if tenant.line_channel_id else 'å°šæœªè¨­å®š') if is_edit else 'é»æ“Šä¸Šæ–¹æŒ‰éˆ•ç²å–' }}"
                class="{{ 'readonly-input' if not is_edit else '' }}">
            <small>
                {% if is_edit %}
                {% if tenant.line_channel_id %}
                âœ“ å·²ç¶å®š
                {% else %}
                å°šæœªç¶å®š
                {% endif %}
                {% else %}
                è«‹å…ˆå¡«å…¥ Channel Access Tokenï¼Œç„¶å¾Œé»æ“Šã€Œç²å– Bot User IDã€æŒ‰éˆ•
                {% endif %}
            </small>
        </div>

        <!-- Notion Config -->
        <h2 style="margin-top: 30px;">
            <i data-lucide="database" style="width: 16px; height: 16px; margin-right: 8px; vertical-align: middle;"></i>
            Notion è¨­å®š
        </h2>

        <div class="form-group form-check">
            <input type="checkbox" id="use_shared_notion_api" name="use_shared_notion_api" {{ 'checked' if (not tenant
                or tenant.use_shared_notion_api) else '' }} onchange="toggleNotionApiKey()">
            <label for="use_shared_notion_api">ä½¿ç”¨å…±ç”¨ Notion API Key</label>
            <small style="display: block; margin-left: 26px; color: var(--text-muted);">å»ºè­°é–‹å•Ÿï¼Œä½¿ç”¨ç³»çµ±çš„ Notion API</small>
        </div>

        <div class="form-group" id="notion_api_key_group" {% if not tenant or tenant.use_shared_notion_api %}hidden{%
            endif %}>
            <label for="notion_api_key">Notion API Key</label>
            <input type="password" id="notion_api_key" name="notion_api_key"
                placeholder="{{ 'å·²è¨­å®š (ç•™ç©ºä¿æŒä¸è®Š)' if is_edit and tenant.notion_api_key else 'secret_xxxxxx...' }}">
            <small>åœ¨ <a href="https://www.notion.so/my-integrations" target="_blank"
                    style="color: var(--accent-purple);">Notion Integrations</a> å»ºç«‹ä¸¦å–å¾—</small>
        </div>

        {% if not is_edit %}
        <div class="form-group form-check">
            <input type="checkbox" id="auto_create_notion_db" name="auto_create_notion_db" checked
                onchange="toggleNotionDbInput()">
            <label for="auto_create_notion_db">è‡ªå‹•å‰µå»º Notion è³‡æ–™åº«</label>
            <small style="display: block; margin-left: 26px; color: var(--text-muted);">
                ç³»çµ±å°‡è‡ªå‹•å‰µå»ºã€Œ{ç§Ÿæˆ¶åç¨±}çš„åç‰‡ç›’ã€è³‡æ–™åº«ï¼ŒåŒ…å«æ‰€æœ‰å¿…è¦æ¬„ä½
            </small>
        </div>
        {% endif %}

        <div class="form-group" id="notion_database_id_group" {% if not is_edit %}hidden{% endif %}>
            <label for="notion_database_id">Notion Database ID {{ '*' if is_edit else '' }}</label>
            <div class="input-with-button">
                <input type="text" id="notion_database_id" name="notion_database_id"
                    value="{{ tenant.notion_database_id if tenant else '' }}" {% if is_edit %}required{% endif %}
                    placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx">
                <button type="button" onclick="fetchNotionDatabaseInfo()" class="btn btn-secondary">
                    <i data-lucide="search" style="width: 16px; height: 16px;"></i>
                    é©—è­‰è³‡æ–™åº«
                </button>
            </div>
            <div id="notion_db_status" class="status-message"></div>
            <small>
                {% if is_edit %}
                Database URL ä¸­çš„ ID éƒ¨åˆ†
                {% else %}
                è‹¥ä¸è‡ªå‹•å‰µå»ºï¼Œè«‹å¡«å…¥ç¾æœ‰è³‡æ–™åº« ID
                {% endif %}
            </small>
        </div>

        <!-- Google AI Config -->
        <h2 style="margin-top: 30px;">
            <i data-lucide="sparkles" style="width: 16px; height: 16px; margin-right: 8px; vertical-align: middle;"></i>
            Google AI è¨­å®š
        </h2>

        <div class="form-group form-check">
            <input type="checkbox" id="use_shared_google_api" name="use_shared_google_api" {{ 'checked' if (not tenant
                or tenant.use_shared_google_api) else '' }} onchange="toggleGoogleApiKey()">
            <label for="use_shared_google_api">ä½¿ç”¨å…±ç”¨ Google API Key</label>
            <small style="display: block; margin-left: 26px; color: var(--text-muted);">å»ºè­°é–‹å•Ÿï¼Œä½¿ç”¨ç³»çµ±çš„ Google Gemini
                API</small>
        </div>

        <div class="form-group" id="google_api_key_group" {% if not tenant or tenant.use_shared_google_api %}hidden{%
            endif %}>
            <label for="google_api_key">Google API Key</label>
            <input type="password" id="google_api_key" name="google_api_key"
                placeholder="{{ 'å·²è¨­å®š (ç•™ç©ºä¿æŒä¸è®Š)' if is_edit and tenant.google_api_key else 'AIza...' }}">
            <small>ç§Ÿæˆ¶å°ˆç”¨çš„ Google Gemini API Key</small>
        </div>

        <!-- Limits -->
        <h2 style="margin-top: 30px;">
            <i data-lucide="gauge" style="width: 16px; height: 16px; margin-right: 8px; vertical-align: middle;"></i>
            ä½¿ç”¨é™åˆ¶
        </h2>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div class="form-group">
                <label for="daily_card_limit">æ¯æ—¥åç‰‡ä¸Šé™</label>
                <input type="number" id="daily_card_limit" name="daily_card_limit"
                    value="{{ tenant.daily_card_limit if tenant else 50 }}" min="1" max="1000">
                <small>æ¯å€‹ç”¨æˆ¶æ¯å¤©å¯è™•ç†çš„åç‰‡æ•¸é‡</small>
            </div>

            <div class="form-group">
                <label for="batch_size_limit">æ‰¹æ¬¡å¤§å°ä¸Šé™</label>
                <input type="number" id="batch_size_limit" name="batch_size_limit"
                    value="{{ tenant.batch_size_limit if tenant else 10 }}" min="1" max="50">
                <small>æ‰¹æ¬¡æ¨¡å¼ä¸­çš„æœ€å¤§åç‰‡æ•¸é‡</small>
            </div>
        </div>
    </form>

    <!-- Actions (outside form to avoid nesting) -->
    <div style="margin-top: 30px; display: flex; gap: 10px;">
        <button type="submit" form="tenant-form" id="submit-btn" class="btn btn-primary" {% if not is_edit %}disabled
            title="è«‹å…ˆç²å– Bot User ID" {% endif %}>
            <i data-lucide="{{ 'save' if is_edit else 'plus' }}" style="width: 16px; height: 16px;"></i>
            {{ 'å„²å­˜è®Šæ›´' if is_edit else 'å»ºç«‹ç§Ÿæˆ¶' }}
        </button>
        <a href="{{ url_for('admin.list_tenants') }}" class="btn btn-secondary">
            <i data-lucide="x" style="width: 16px; height: 16px;"></i>
            å–æ¶ˆ
        </a>

        {% if is_edit %}
        <form method="POST" action="{{ url_for('admin.delete_tenant', tenant_id=tenant.id) }}"
            style="margin-left: auto;" onsubmit="return confirm('ç¢ºå®šè¦åœç”¨æ­¤ç§Ÿæˆ¶å—ï¼Ÿ');">
            <button type="submit" class="btn btn-danger">
                <i data-lucide="pause-circle" style="width: 16px; height: 16px;"></i>
                åœç”¨ç§Ÿæˆ¶
            </button>
        </form>
        {% endif %}
    </div>
</div>

{% if is_edit %}
<!-- Google Drive Batch Processing -->
<div class="card" style="margin-top: 20px;">
    <h2>
        <i data-lucide="hard-drive" style="width: 16px; height: 16px; margin-right: 8px; vertical-align: middle;"></i>
        Google Drive æ‰¹æ¬¡è™•ç†
    </h2>
    <p style="color: var(--text-muted); margin-bottom: 20px;">
        å¾ Google Drive è³‡æ–™å¤¾æ‰¹æ¬¡åŒ¯å…¥åç‰‡åœ–ç‰‡ï¼Œè‡ªå‹•è­˜åˆ¥ä¸¦å„²å­˜åˆ° Notionã€‚
    </p>

    <div class="form-group">
        <label for="google_drive_folder_url">Google Drive è³‡æ–™å¤¾ç¶²å€</label>
        <div class="input-with-button">
            <input type="text" id="google_drive_folder_url" name="google_drive_folder_url"
                value="{{ tenant.google_drive_folder_url or '' }}"
                placeholder="https://drive.google.com/drive/folders/xxxxx">
            <button type="button" onclick="fetchDriveFolderInfo()" class="btn btn-secondary" id="fetch-drive-btn">
                <i data-lucide="search" style="width: 16px; height: 16px;"></i> Fetch
            </button>
        </div>
        <div id="drive_folder_status" class="status-message"></div>
        <small style="color: var(--text-muted);">
            è«‹ç¢ºä¿å·²å°‡è³‡æ–™å¤¾å…±äº«çµ¦ç³»çµ± Service Accountï¼ˆéœ€ã€Œç·¨è¼¯è€…ã€æ¬Šé™æ‰èƒ½é‡æ–°å‘½åæª”æ¡ˆï¼‰
        </small>
    </div>

    <div id="drive_sync_section"
        style="display: none; margin-top: 20px; padding: 15px; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border-color);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <div>
                <span style="font-size: 1.1rem; font-weight: 500;">
                    ğŸ“ <span id="drive_folder_name">è³‡æ–™å¤¾</span>
                </span>
                <div style="color: var(--text-muted); font-size: 0.9rem; margin-top: 5px;">
                    <span id="drive_file_count">0</span> å€‹åœ–ç‰‡æª”æ¡ˆãƒ»
                    <span id="drive_unprocessed_count">0</span> å€‹å¾…è™•ç†
                </div>
            </div>
            <button type="button" onclick="startDriveSync()" class="btn btn-primary" id="sync_btn">
                <i data-lucide="refresh-cw" style="width: 16px; height: 16px;"></i> é–‹å§‹åŒæ­¥
            </button>
        </div>

        <div id="drive_last_sync_info" style="color: var(--text-muted); font-size: 0.85rem;">
            ä¸Šæ¬¡åŒæ­¥ï¼š<span id="drive_last_sync">å¾æœª</span>
        </div>
    </div>

    <div id="sync_progress_section"
        style="display: none; margin-top: 20px; padding: 15px; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border-color);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <span style="font-weight: 500;">è™•ç†ä¸­...</span>
            <span id="sync_progress_text">0%</span>
        </div>
        <div style="height: 8px; background: var(--border-color); border-radius: 4px; overflow: hidden;">
            <div id="sync_progress_bar"
                style="height: 100%; background: var(--accent-purple); width: 0%; transition: width 0.3s;"></div>
        </div>
        <div
            style="display: flex; justify-content: space-between; margin-top: 10px; font-size: 0.85rem; color: var(--text-muted);">
            <span>âœ… æˆåŠŸ: <span id="sync_success_count">0</span></span>
            <span>âŒ å¤±æ•—: <span id="sync_error_count">0</span></span>
            <span>â­ï¸ ç•¥é: <span id="sync_skipped_count">0</span></span>
        </div>
    </div>

    <div id="sync_result_section" style="display: none; margin-top: 20px; padding: 15px; border-radius: 8px;"></div>

    <!-- Scheduled Sync Settings -->
    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color);">
        <h3 style="font-size: 1rem; margin-bottom: 15px;">
            <i data-lucide="clock" style="width: 16px; height: 16px; margin-right: 8px; vertical-align: middle;"></i>
            è‡ªå‹•åŒæ­¥æ’ç¨‹
        </h3>

        <div class="form-group form-check" style="margin-bottom: 15px;">
            <input type="checkbox" id="google_drive_sync_enabled" name="google_drive_sync_enabled" {{ 'checked' if
                tenant.google_drive_sync_enabled else '' }} onchange="toggleScheduleSettings()">
            <label for="google_drive_sync_enabled">å•Ÿç”¨è‡ªå‹•åŒæ­¥</label>
            <small style="display: block; margin-left: 26px; color: var(--text-muted);">
                ç³»çµ±å°‡æŒ‰è¨­å®šæ™‚é–“è‡ªå‹•åŸ·è¡Œ Google Drive åŒæ­¥
            </small>
        </div>

        <div id="schedule_settings"
            style="display: {{ 'block' if tenant.google_drive_sync_enabled else 'none' }}; padding-left: 26px;">
            <div class="form-group">
                <label for="sync_schedule_time">åŒæ­¥æ™‚é–“</label>
                <select id="sync_schedule_time" name="sync_schedule_time" style="width: auto;">
                    {% set current_schedule = tenant.google_drive_sync_schedule or '0 9 * * *' %}
                    <option value="0 6 * * *" {{ 'selected' if current_schedule=='0 6 * * *' else '' }}>æ¯æ—¥ 06:00
                    </option>
                    <option value="0 9 * * *" {{ 'selected' if current_schedule=='0 9 * * *' else '' }}>æ¯æ—¥ 09:00
                    </option>
                    <option value="0 12 * * *" {{ 'selected' if current_schedule=='0 12 * * *' else '' }}>æ¯æ—¥ 12:00
                    </option>
                    <option value="0 18 * * *" {{ 'selected' if current_schedule=='0 18 * * *' else '' }}>æ¯æ—¥ 18:00
                    </option>
                    <option value="0 21 * * *" {{ 'selected' if current_schedule=='0 21 * * *' else '' }}>æ¯æ—¥ 21:00
                    </option>
                    <option value="0 9 * * 1" {{ 'selected' if current_schedule=='0 9 * * 1' else '' }}>æ¯é€±ä¸€ 09:00
                    </option>
                    <option value="0 9 * * 5" {{ 'selected' if current_schedule=='0 9 * * 5' else '' }}>æ¯é€±äº” 09:00
                    </option>
                </select>
                <small style="display: block; margin-top: 5px; color: var(--text-muted);">
                    æ™‚å€ï¼šä¼ºæœå™¨æ™‚é–“ (UTC+0)
                </small>
            </div>

            <button type="button" onclick="saveScheduleSettings()" class="btn btn-secondary" id="save_schedule_btn"
                style="margin-top: 10px;">
                <i data-lucide="save" style="width: 16px; height: 16px;"></i> å„²å­˜æ’ç¨‹è¨­å®š
            </button>
            <span id="schedule_save_status" style="margin-left: 10px; font-size: 0.9rem;"></span>
        </div>
    </div>
</div>

<!-- Webhook Info -->
<div class="card" style="margin-top: 20px;">
    <h2>
        <i data-lucide="link" style="width: 16px; height: 16px; margin-right: 8px; vertical-align: middle;"></i>
        Webhook è¨­å®šèªªæ˜
    </h2>
    <p style="color: var(--text-muted);">è«‹åœ¨ LINE Developers Console ä¸­è¨­å®šä»¥ä¸‹ Webhook URLï¼š</p>
    <div
        style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; margin-top: 10px; border: 1px solid var(--border-color);">
        <code style="font-size: 1rem; color: var(--accent-purple);">https://eco-namecard.zeabur.app/callback</code>
    </div>
    <p style="color: var(--text-muted); margin-top: 10px; font-size: 0.9rem;">
        <i data-lucide="info" style="width: 14px; height: 14px; margin-right: 4px; vertical-align: middle;"></i>
        æ‰€æœ‰ç§Ÿæˆ¶ä½¿ç”¨ç›¸åŒçš„ Webhook URLï¼Œç³»çµ±æœƒæ ¹æ“š Bot User ID è‡ªå‹•è­˜åˆ¥ç§Ÿæˆ¶ã€‚
    </p>
</div>
{% endif %}

<script>
    function toggleGoogleApiKey() {
        const checkbox = document.getElementById('use_shared_google_api');
        const group = document.getElementById('google_api_key_group');
        group.hidden = checkbox.checked;
    }

    function toggleNotionApiKey() {
        const checkbox = document.getElementById('use_shared_notion_api');
        const group = document.getElementById('notion_api_key_group');
        group.hidden = checkbox.checked;
    }

    function toggleNotionDbInput() {
        const checkbox = document.getElementById('auto_create_notion_db');
        const group = document.getElementById('notion_database_id_group');
        const input = document.getElementById('notion_database_id');
        if (checkbox) {
            group.hidden = checkbox.checked;
            input.required = !checkbox.checked;
        }
    }

    // é©—è­‰ Notion Database
    async function fetchNotionDatabaseInfo() {
        const databaseIdInput = document.getElementById('notion_database_id');
        const notionApiKeyInput = document.getElementById('notion_api_key');
        const useSharedApiCheckbox = document.getElementById('use_shared_notion_api');
        const statusDiv = document.getElementById('notion_db_status');
        const verifyBtn = event.target.closest('button');

        const databaseId = databaseIdInput.value.trim();
        const notionApiKey = notionApiKeyInput ? notionApiKeyInput.value.trim() : '';
        const useSharedApi = useSharedApiCheckbox ? useSharedApiCheckbox.checked : false;

        // é©—è­‰è¼¸å…¥
        if (!databaseId) {
            statusDiv.className = 'status-message error';
            statusDiv.innerHTML = 'âŒ è«‹å…ˆå¡«å¯« Database ID';
            return;
        }

        if (!useSharedApi && !notionApiKey) {
            statusDiv.className = 'status-message error';
            statusDiv.innerHTML = 'âŒ è«‹å…ˆå¡«å¯« Notion API Key æˆ–å‹¾é¸ä½¿ç”¨å…±ç”¨ API Key';
            return;
        }

        // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
        statusDiv.className = 'status-message info';
        statusDiv.innerHTML = 'â³ æ­£åœ¨é©—è­‰ Notion Database...';
        verifyBtn.disabled = true;
        verifyBtn.innerHTML = '<i data-lucide="loader" style="width: 16px; height: 16px; animation: spin 1s linear infinite;"></i> é©—è­‰ä¸­...';

        try {
            const response = await fetch('{{ url_for("admin.fetch_notion_database_info") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    database_id: databaseId,
                    notion_api_key: notionApiKey,
                    use_shared_api: useSharedApi,
                }),
            });

            const data = await response.json();

            if (data.success) {
                statusDiv.className = 'status-message success';
                let message = `âœ… é©—è­‰æˆåŠŸï¼<br><strong>è³‡æ–™åº«åç¨±:</strong> ${data.database_title}`;

                // é¡¯ç¤ºå¯¦éš›è®€å–åˆ°çš„æ¬„ä½
                if (data.actual_fields && data.actual_fields.length > 0) {
                    message += `<br><strong>è®€å–åˆ° ${data.field_count} å€‹æ¬„ä½:</strong> ${data.actual_fields.join(', ')}`;
                }

                if (data.warning) {
                    message += `<br><span class="status-warning">âš ï¸ ${data.warning}</span>`;
                    if (data.debug_info) {
                        message += `<br><small>${data.debug_info}</small>`;
                    }
                }

                statusDiv.innerHTML = message;

                // è‡ªå‹•å¡«å…¥æ­£ç¢ºçš„ database_idï¼ˆç„¡ hyphensï¼‰
                databaseIdInput.value = data.database_id;

                // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
                verifyBtn.innerHTML = '<i data-lucide="check" style="width: 16px; height: 16px;"></i> å·²é©—è­‰';
                verifyBtn.style.background = 'var(--accent-green)';
                verifyBtn.style.borderColor = 'var(--accent-green)';
                verifyBtn.style.color = 'white';
            } else {
                statusDiv.className = 'status-message error';
                statusDiv.innerHTML = `âŒ é©—è­‰å¤±æ•—ï¼š${data.error}`;

                verifyBtn.disabled = false;
                verifyBtn.innerHTML = '<i data-lucide="search" style="width: 16px; height: 16px;"></i> é‡æ–°é©—è­‰';
            }
        } catch (error) {
            statusDiv.className = 'status-message error';
            statusDiv.innerHTML = `âŒ ç¶²è·¯éŒ¯èª¤ï¼š${error.message}`;

            verifyBtn.disabled = false;
            verifyBtn.innerHTML = '<i data-lucide="search" style="width: 16px; height: 16px;"></i> é‡æ–°é©—è­‰';
        }

        // é‡æ–°åˆå§‹åŒ– Lucide åœ–æ¨™
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    }

    // ç²å– Bot User ID
    async function fetchBotUserId() {
        const accessToken = document.getElementById('line_channel_access_token').value.trim();
        const statusDiv = document.getElementById('fetch-status');
        const botIdInput = document.getElementById('line_channel_id');
        const fetchBtn = document.getElementById('fetch-bot-id-btn');
        const submitBtn = document.getElementById('submit-btn');

        // é©—è­‰ Access Token æ˜¯å¦å·²å¡«å…¥
        if (!accessToken) {
            statusDiv.style.display = 'block';
            statusDiv.style.background = 'var(--accent-red-bg, #fee2e2)';
            statusDiv.style.color = 'var(--accent-red, #dc2626)';
            statusDiv.style.border = '1px solid var(--accent-red, #dc2626)';
            statusDiv.innerHTML = 'âš ï¸ è«‹å…ˆå¡«å…¥ Channel Access Token';
            return;
        }

        // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
        fetchBtn.disabled = true;
        fetchBtn.innerHTML = '<i data-lucide="loader" style="width: 16px; height: 16px; animation: spin 1s linear infinite;"></i> ç²å–ä¸­...';
        statusDiv.style.display = 'block';
        statusDiv.style.background = 'var(--bg-secondary)';
        statusDiv.style.color = 'var(--text-primary)';
        statusDiv.style.border = '1px solid var(--border-color)';
        statusDiv.innerHTML = 'â³ æ­£åœ¨é€£æ¥ LINE API...';

        try {
            const response = await fetch('{{ url_for("admin.fetch_bot_user_id") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    access_token: accessToken
                })
            });

            const data = await response.json();

            if (data.success) {
                // æˆåŠŸç²å–
                botIdInput.value = data.bot_user_id;
                statusDiv.style.background = 'var(--accent-green-bg, #dcfce7)';
                statusDiv.style.color = 'var(--accent-green, #16a34a)';
                statusDiv.style.border = '1px solid var(--accent-green, #16a34a)';
                statusDiv.innerHTML = `âœ“ æˆåŠŸç²å–ï¼<br><strong>Bot User ID:</strong> ${data.bot_user_id}<br><strong>Bot åç¨±:</strong> ${data.bot_name || '(æœªè¨­å®š)'}`;

                // å•Ÿç”¨æäº¤æŒ‰éˆ•
                submitBtn.disabled = false;
                submitBtn.title = '';

                // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
                fetchBtn.innerHTML = '<i data-lucide="check" style="width: 16px; height: 16px;"></i> å·²ç²å–';
                fetchBtn.style.background = 'var(--accent-green)';
                fetchBtn.style.borderColor = 'var(--accent-green)';
                fetchBtn.style.color = 'white';
            } else {
                // ç²å–å¤±æ•—
                statusDiv.style.background = 'var(--accent-red-bg, #fee2e2)';
                statusDiv.style.color = 'var(--accent-red, #dc2626)';
                statusDiv.style.border = '1px solid var(--accent-red, #dc2626)';
                statusDiv.innerHTML = `âŒ ç²å–å¤±æ•—ï¼š${data.error}`;

                fetchBtn.disabled = false;
                fetchBtn.innerHTML = '<i data-lucide="search" style="width: 16px; height: 16px;"></i> é‡æ–°ç²å–';
            }
        } catch (error) {
            statusDiv.style.background = 'var(--accent-red-bg, #fee2e2)';
            statusDiv.style.color = 'var(--accent-red, #dc2626)';
            statusDiv.style.border = '1px solid var(--accent-red, #dc2626)';
            statusDiv.innerHTML = `âŒ ç¶²è·¯éŒ¯èª¤ï¼š${error.message}`;

            fetchBtn.disabled = false;
            fetchBtn.innerHTML = '<i data-lucide="search" style="width: 16px; height: 16px;"></i> é‡æ–°ç²å–';
        }

        // é‡æ–°åˆå§‹åŒ– Lucide åœ–æ¨™
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    }

    // æ·»åŠ  CSS å‹•ç•«
    const style = document.createElement('style');
    style.textContent = `
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
`;
    document.head.appendChild(style);

    // ==================== SocketIO Setup ====================

    let socket = null;
    let socketConnected = false;

    function initSocketIO() {
        // Load SocketIO client
        if (typeof io === 'undefined') {
            const script = document.createElement('script');
            script.src = 'https://cdn.socket.io/4.6.0/socket.io.min.js';
            script.onload = connectSocket;
            document.head.appendChild(script);
        } else {
            connectSocket();
        }
    }

    function connectSocket() {
        try {
            socket = io(window.location.origin, {
                transports: ['websocket', 'polling']
            });

            socket.on('connect', () => {
                console.log('SocketIO connected');
                socketConnected = true;
                // Join the tenant's sync room
                socket.emit('join_sync_room', { tenant_id: TENANT_ID });
            });

            socket.on('disconnect', () => {
                console.log('SocketIO disconnected');
                socketConnected = false;
            });

            socket.on('sync_progress', (data) => {
                console.log('Sync progress:', data);
                updateProgressUI(
                    data.progress_percent || 0,
                    data.success_count || 0,
                    data.error_count || 0,
                    data.skipped_count || 0,
                    data.processed_files || 0
                );

                // Update current file being processed
                if (data.current_file) {
                    document.getElementById('sync_progress_text').textContent =
                        `${Math.round(data.progress_percent || 0)}% - ${data.current_file}`;
                }
            });

            socket.on('sync_completed', (data) => {
                console.log('Sync completed:', data);

                // Stop polling if running
                if (syncPollingInterval) {
                    clearInterval(syncPollingInterval);
                    syncPollingInterval = null;
                }

                if (data.status === 'completed') {
                    showSyncResult('success',
                        `åŒæ­¥å®Œæˆï¼æˆåŠŸ ${data.success_count || 0} å¼µï¼Œå¤±æ•— ${data.error_count || 0} å¼µ`
                    );
                } else if (data.status === 'failed') {
                    showSyncResult('error', data.error || 'åŒæ­¥å¤±æ•—');
                } else if (data.status === 'cancelled') {
                    showSyncResult('warning', 'åŒæ­¥å·²å–æ¶ˆ');
                }

                // Refresh folder info
                setTimeout(() => fetchDriveFolderInfo(), 1000);
            });

            socket.on('room_joined', (data) => {
                console.log('Joined sync room:', data.room);
            });

        } catch (error) {
            console.error('SocketIO connection failed:', error);
            socketConnected = false;
        }
    }

    // Initialize SocketIO when page loads
    {% if is_edit %}
    document.addEventListener('DOMContentLoaded', initSocketIO);
    {% endif %}

    // ==================== Google Drive Functions ====================

    let syncPollingInterval = null;
    const TENANT_ID = '{{ tenant.id if tenant else "" }}';

    // Fetch Google Drive folder info
    async function fetchDriveFolderInfo() {
        const folderUrlInput = document.getElementById('google_drive_folder_url');
        const statusDiv = document.getElementById('drive_folder_status');
        const fetchBtn = document.getElementById('fetch-drive-btn');
        const syncSection = document.getElementById('drive_sync_section');

        const folderUrl = folderUrlInput.value.trim();

        if (!folderUrl) {
            statusDiv.className = 'status-message error';
            statusDiv.innerHTML = 'âŒ è«‹è¼¸å…¥ Google Drive è³‡æ–™å¤¾ç¶²å€';
            statusDiv.style.display = 'block';
            return;
        }

        // Show loading state
        statusDiv.className = 'status-message info';
        statusDiv.innerHTML = 'â³ æ­£åœ¨é©—è­‰è³‡æ–™å¤¾...';
        statusDiv.style.display = 'block';
        fetchBtn.disabled = true;
        fetchBtn.innerHTML = '<i data-lucide="loader" style="width: 16px; height: 16px; animation: spin 1s linear infinite;"></i> é©—è­‰ä¸­...';

        try {
            const response = await fetch('{{ url_for("admin.fetch_drive_folder") }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ folder_url: folderUrl })
            });

            const data = await response.json();

            if (data.success) {
                statusDiv.className = 'status-message success';
                statusDiv.innerHTML = `âœ… ${data.message}`;

                // Update sync section
                document.getElementById('drive_folder_name').textContent = data.folder_name;
                document.getElementById('drive_file_count').textContent = data.total_files;
                document.getElementById('drive_unprocessed_count').textContent = data.unprocessed_files;

                syncSection.style.display = 'block';

                // Update button
                fetchBtn.innerHTML = '<i data-lucide="check" style="width: 16px; height: 16px;"></i> å·²é©—è­‰';
                fetchBtn.style.background = 'var(--accent-green)';
                fetchBtn.style.borderColor = 'var(--accent-green)';
                fetchBtn.style.color = 'white';
            } else {
                statusDiv.className = 'status-message error';
                let errorMsg = `âŒ ${data.error}`;
                if (data.service_account_email) {
                    errorMsg += `<br><small>è«‹å°‡è³‡æ–™å¤¾å…±äº«çµ¦: <code>${data.service_account_email}</code></small>`;
                }
                statusDiv.innerHTML = errorMsg;
                syncSection.style.display = 'none';

                fetchBtn.disabled = false;
                fetchBtn.innerHTML = '<i data-lucide="search" style="width: 16px; height: 16px;"></i> é‡è©¦';
            }
        } catch (error) {
            statusDiv.className = 'status-message error';
            statusDiv.innerHTML = `âŒ ç¶²è·¯éŒ¯èª¤ï¼š${error.message}`;
            fetchBtn.disabled = false;
            fetchBtn.innerHTML = '<i data-lucide="search" style="width: 16px; height: 16px;"></i> é‡è©¦';
        }

        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    }

    // Start Drive sync
    async function startDriveSync() {
        const folderUrl = document.getElementById('google_drive_folder_url').value.trim();
        const syncBtn = document.getElementById('sync_btn');
        const syncSection = document.getElementById('drive_sync_section');
        const progressSection = document.getElementById('sync_progress_section');
        const resultSection = document.getElementById('sync_result_section');

        if (!folderUrl) {
            alert('è«‹å…ˆè¼¸å…¥ä¸¦é©—è­‰ Google Drive è³‡æ–™å¤¾ç¶²å€');
            return;
        }

        // Show progress section
        syncSection.style.display = 'none';
        progressSection.style.display = 'block';
        resultSection.style.display = 'none';

        // Reset progress
        updateProgressUI(0, 0, 0, 0, 0);

        try {
            const response = await fetch(`/admin/api/drive/sync/${TENANT_ID}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ folder_url: folderUrl })
            });

            const data = await response.json();

            if (data.success) {
                // Start polling for progress
                startSyncPolling();
            } else {
                showSyncResult('error', data.error);
            }
        } catch (error) {
            showSyncResult('error', `å•Ÿå‹•åŒæ­¥å¤±æ•—ï¼š${error.message}`);
        }
    }

    // Update progress UI
    function updateProgressUI(percent, success, errors, skipped, processed) {
        document.getElementById('sync_progress_bar').style.width = `${percent}%`;
        document.getElementById('sync_progress_text').textContent = `${Math.round(percent)}%`;
        document.getElementById('sync_success_count').textContent = success;
        document.getElementById('sync_error_count').textContent = errors;
        document.getElementById('sync_skipped_count').textContent = skipped;
    }

    // Start polling for sync status (fallback when WebSocket not connected)
    function startSyncPolling() {
        // If WebSocket is connected, don't use polling
        if (socketConnected) {
            console.log('Using WebSocket for progress updates');
            return;
        }

        if (syncPollingInterval) {
            clearInterval(syncPollingInterval);
        }

        syncPollingInterval = setInterval(async () => {
            // Stop polling if WebSocket connected
            if (socketConnected) {
                clearInterval(syncPollingInterval);
                syncPollingInterval = null;
                return;
            }

            try {
                const response = await fetch(`/admin/api/drive/sync-status/${TENANT_ID}`);
                const data = await response.json();

                if (data.success) {
                    if (data.is_syncing) {
                        updateProgressUI(
                            data.progress_percent,
                            data.success_count,
                            data.error_count,
                            data.skipped_count,
                            data.processed_files
                        );
                    } else {
                        // Sync completed
                        clearInterval(syncPollingInterval);
                        syncPollingInterval = null;

                        if (data.last_sync) {
                            const status = data.last_sync.status;
                            if (status === 'completed') {
                                showSyncResult('success',
                                    `åŒæ­¥å®Œæˆï¼æˆåŠŸ ${data.last_sync.success_count} å¼µï¼Œå¤±æ•— ${data.last_sync.error_count} å¼µ`
                                );
                            } else if (status === 'failed') {
                                showSyncResult('error', 'åŒæ­¥å¤±æ•—ï¼Œè«‹æŸ¥çœ‹æ—¥èªŒ');
                            } else if (status === 'cancelled') {
                                showSyncResult('warning', 'åŒæ­¥å·²å–æ¶ˆ');
                            }
                        }

                        // Refresh folder info
                        setTimeout(() => fetchDriveFolderInfo(), 1000);
                    }
                }
            } catch (error) {
                console.error('Polling error:', error);
            }
        }, 2000); // Poll every 2 seconds
    }

    // Show sync result
    function showSyncResult(type, message) {
        const progressSection = document.getElementById('sync_progress_section');
        const resultSection = document.getElementById('sync_result_section');
        const syncSection = document.getElementById('drive_sync_section');

        progressSection.style.display = 'none';
        resultSection.style.display = 'block';

        const colors = {
            success: { bg: 'var(--accent-green-bg, #dcfce7)', color: 'var(--accent-green, #16a34a)', icon: 'âœ…' },
            error: { bg: 'var(--accent-red-bg, #fee2e2)', color: 'var(--accent-red, #dc2626)', icon: 'âŒ' },
            warning: { bg: 'var(--accent-yellow-bg, #fef9c3)', color: 'var(--accent-yellow, #ca8a04)', icon: 'âš ï¸' }
        };

        const style = colors[type] || colors.error;
        resultSection.style.background = style.bg;
        resultSection.style.color = style.color;
        resultSection.style.border = `1px solid ${style.color}`;
        resultSection.innerHTML = `${style.icon} ${message}`;

        // Show sync section after a delay
        setTimeout(() => {
            syncSection.style.display = 'block';
        }, 2000);
    }

    // Check for active sync on page load
    {% if is_edit %}
    document.addEventListener('DOMContentLoaded', async function () {
        try {
            const response = await fetch(`/admin/api/drive/sync-status/${TENANT_ID}`);
            const data = await response.json();

            if (data.success && data.is_syncing) {
                // Resume showing progress
                document.getElementById('drive_sync_section').style.display = 'none';
                document.getElementById('sync_progress_section').style.display = 'block';
                startSyncPolling();
            } else if (data.folder_url) {
                // Has folder URL, show fetch button ready
                document.getElementById('drive_folder_status').style.display = 'none';
            }

            // Update last sync time
            if (data.last_sync_time) {
                const lastSync = new Date(data.last_sync_time);
                document.getElementById('drive_last_sync').textContent = lastSync.toLocaleString('zh-TW');
            }
        } catch (error) {
            console.error('Failed to check sync status:', error);
        }
    });
    {% endif %}

    // ==================== Schedule Settings ====================

    function toggleScheduleSettings() {
        const checkbox = document.getElementById('google_drive_sync_enabled');
        const settings = document.getElementById('schedule_settings');
        settings.style.display = checkbox.checked ? 'block' : 'none';
    }

    async function saveScheduleSettings() {
        const enabled = document.getElementById('google_drive_sync_enabled').checked;
        const schedule = document.getElementById('sync_schedule_time').value;
        const saveBtn = document.getElementById('save_schedule_btn');
        const statusSpan = document.getElementById('schedule_save_status');

        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i data-lucide="loader" style="width: 16px; height: 16px; animation: spin 1s linear infinite;"></i> å„²å­˜ä¸­...';
        statusSpan.textContent = '';

        try {
            const response = await fetch(`/admin/api/drive/schedule/${TENANT_ID}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    enabled: enabled,
                    schedule: schedule
                })
            });

            const data = await response.json();

            if (data.success) {
                statusSpan.style.color = 'var(--accent-green)';
                statusSpan.textContent = 'âœ“ å·²å„²å­˜';
                saveBtn.innerHTML = '<i data-lucide="check" style="width: 16px; height: 16px;"></i> å·²å„²å­˜';
                saveBtn.style.background = 'var(--accent-green)';

                setTimeout(() => {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = '<i data-lucide="save" style="width: 16px; height: 16px;"></i> å„²å­˜æ’ç¨‹è¨­å®š';
                    saveBtn.style.background = '';
                    statusSpan.textContent = '';
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                }, 2000);
            } else {
                throw new Error(data.error || 'å„²å­˜å¤±æ•—');
            }
        } catch (error) {
            statusSpan.style.color = 'var(--accent-red)';
            statusSpan.textContent = `âŒ ${error.message}`;
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i data-lucide="save" style="width: 16px; height: 16px;"></i> é‡è©¦';
        }

        if (typeof lucide !== 'undefined') lucide.createIcons();
    }
</script>
{% endblock %}