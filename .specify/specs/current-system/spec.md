# 功能規格：LINE Bot 名片管理系統

## 概述
一個整合 LINE Bot、Google Gemini AI 和 Notion 的名片管理系統，能夠自動辨識名片內容並儲存至 Notion 資料庫。系統支援批次處理、多卡片偵測，並具備完整的安全性和錯誤處理機制。

## 使用者故事

### 基本功能
- 身為使用者，我想要傳送名片照片給 LINE Bot，以便自動辨識並儲存名片資訊
- 身為使用者，我想要在一張照片中放多張名片，以便一次處理多張名片
- 身為使用者，我想要使用批次模式，以便連續上傳多張名片而不需要每次確認
- 身為使用者，我想要查詢處理狀態，以便了解已處理的名片數量和進度

### 查詢功能
- 身為使用者，我想要搜尋已儲存的名片，以便快速找到特定人員或公司的資訊
- 身為使用者，我想要查看自己儲存的所有名片，以便管理我的人脈資料

### 使用體驗
- 身為使用者，我想要收到清楚的中文訊息，以便理解系統狀態和操作指引
- 身為使用者，我想要快速的回應時間（2秒內），以便流暢地使用服務

## 功能需求

### 核心功能

#### 1. 名片辨識
**描述**：使用 Google Gemini AI 辨識名片內容

**驗收標準**：
- 支援 JPG、PNG 格式的名片照片
- 圖片大小限制 10MB
- 可辨識繁體中文、簡體中文和英文
- 優先擷取中文內容（適合台灣市場）
- 提供信心分數（0-100）評估辨識品質

**預期行為**：
- 自動偵測單張照片中的多張名片
- 正規化台灣電話號碼格式
- 正規化台灣地址格式
- 驗證 Email 格式
- 處理模糊或低品質照片

**邊界情況**：
- 照片中沒有名片 → 回傳友善錯誤訊息
- API 配額用盡 → 使用備援 API 金鑰
- 辨識失敗 → 通知使用者並記錄錯誤
- 多語言名片 → 優先擷取中文資訊

#### 2. 批次處理模式
**描述**：允許使用者連續上傳多張名片

**驗收標準**：
- 使用「批次」命令進入批次模式
- 批次模式下無需每次確認
- 顯示即時處理進度
- 使用「結束批次」命令結束
- 批次大小限制：10 張名片

**預期行為**：
- 維護每位使用者的會話狀態
- 追蹤成功/失敗的處理數量
- 超時自動結束批次（30 分鐘）
- 提供批次處理摘要

**邊界情況**：
- 批次中途發生錯誤 → 繼續處理後續照片
- 達到每日限制 → 通知使用者並結束批次
- 批次超時 → 自動結束並發送摘要

#### 3. Notion 資料儲存
**描述**：將辨識結果結構化儲存至 Notion 資料庫

**驗收標準**：
- 必填欄位：姓名（Title）
- 選填欄位：公司、職稱、部門、電話、Email、地址、網站、LINE ID、傳真
- 支援按姓名和公司搜尋
- 支援查詢特定使用者的所有名片
- 資料驗證和淨化

**預期行為**：
- 優先使用中文作為標題和部門
- 自動建立標題選項（如果不存在）
- 重複名片檢查
- 保留原始辨識資料

**邊界情況**：
- Notion API 失敗 → 重試機制（最多 3 次）
- 資料庫權限不足 → 通知管理員
- 欄位格式錯誤 → 跳過該欄位並記錄

### 使用者體驗

#### 互動流程
1. 使用者傳送「help」查看指令說明
2. 使用者傳送名片照片
3. 系統顯示「處理中...」訊息
4. 系統回傳辨識結果和信心分數
5. 使用者確認儲存或取消

#### 批次模式流程
1. 使用者傳送「批次」進入批次模式
2. 系統確認進入批次模式
3. 使用者連續上傳照片
4. 系統即時回報每張處理結果
5. 使用者傳送「結束批次」或「狀態」
6. 系統顯示批次處理摘要

#### 訊息設計
- 成功訊息：「名片已成功儲存至 Notion！已辨識 X 個欄位。」
- 錯誤訊息：「抱歉，無法辨識此名片。請確認照片清晰且包含名片內容。」
- 進度訊息：「批次模式：已處理 3/10 張名片」
- 提示訊息：使用 Quick Reply 按鈕引導操作

#### 效能要求
- Webhook 回應時間：< 500ms
- AI 辨識時間：< 5 秒
- Notion 儲存時間：< 2 秒
- 總處理時間：< 8 秒

### 資料需求

#### 輸入資料
```python
# 名片照片
{
    "type": "image",
    "format": ["jpg", "jpeg", "png"],
    "max_size": "10MB",
    "source": "LINE message content"
}
```

#### 輸出資料結構
```python
class BusinessCard(BaseModel):
    name: str  # 必填
    company: Optional[str]
    title: Optional[str]
    department: Optional[str]
    phone: Optional[str]
    email: Optional[EmailStr]
    address: Optional[str]
    website: Optional[HttpUrl]
    line_id: Optional[str]
    fax: Optional[str]
    confidence_score: int  # 0-100
    user_id: str  # LINE user ID
```

#### Notion 儲存格式
- 姓名：Title 欄位（繁體中文優先）
- 公司：Text 欄位
- 職稱：Select 欄位（自動建立選項）
- 部門：Select 欄位（自動建立選項）
- 電話：Phone 欄位（台灣格式正規化）
- Email：Email 欄位（格式驗證）
- 地址：Text 欄位（台灣地址正規化）
- 網站：URL 欄位
- LINE ID：Text 欄位
- 傳真：Text 欄位

## 非功能性需求

### 安全性

#### Webhook 驗證
- LINE 簽章驗證（HMAC-SHA256）
- 拒絕無效簽章的請求
- 記錄可疑請求

#### 輸入驗證
- 圖片大小限制（10MB）
- 圖片格式驗證
- 文字內容淨化（防止注入攻擊）
- 使用者輸入過濾

#### 速率限制
- 每位使用者每日限制：50 張名片
- 批次大小限制：10 張
- 自動清理非活躍會話（24 小時）

#### 資料保護
- 敏感資料使用 Fernet 加密
- 環境變數儲存機密資訊
- 不在日誌中記錄敏感資料

### 效能

#### 回應時間
- Webhook 端點：< 500ms
- 健康檢查端點：< 100ms
- AI 辨識：< 5 秒
- 資料庫操作：< 2 秒

#### 吞吐量
- 支援每秒 10 個並發請求
- 批次處理：每批 10 張名片
- 每日處理容量：5000 張名片

#### 可擴展性
- Stateless 設計支援水平擴展
- 使用者會話儲存於記憶體（可改用 Redis）
- 非同步處理長時間任務

### 可靠性

#### 錯誤處理
- 分類錯誤類型（使用者錯誤、系統錯誤、外部服務錯誤）
- 提供友善的中文錯誤訊息
- 自動重試機制（Notion API、AI API）
- 錯誤日誌記錄和監控

#### 備援機制
- Google Gemini API 備援金鑰
- Gemini 2.5 Flash 失敗時自動降級至 1.5 Flash
- 寬鬆的安全設定處理商業名片內容

#### 監控
- Sentry 錯誤追蹤和告警
- 健康檢查端點（/health）
- 系統狀態端點（/test, /debug/notion）
- 應用程式日誌記錄

## 整合點

### LINE Messaging API
- **Webhook URL**: `https://namecard-app.zeabur.app/callback`
- **驗證方式**: HMAC-SHA256 簽章驗證
- **訊息類型**: 文字訊息、圖片訊息
- **回應格式**: TextSendMessage, ImageSendMessage, QuickReply
- **速率限制**: 遵循 LINE 平台限制

### Google Gemini AI
- **主要模型**: `gemini-2.5-flash-preview-0514`
- **備援模型**: `gemini-1.5-flash`
- **API 端點**: Google AI Studio
- **驗證方式**: API Key
- **功能**: 圖片辨識、結構化資料擷取
- **安全設定**: 寬鬆模式（商業名片適用）

### Notion API
- **版本**: Notion API v1
- **驗證方式**: Integration Token
- **操作**: 建立頁面、搜尋、查詢資料庫
- **資料庫**: 預定義的名片資料庫結構
- **權限**: 讀取、寫入、更新

## 成功指標

### 功能指標
- 名片辨識準確率：> 90%（信心分數 > 80）
- 批次處理成功率：> 95%
- API 可用性：> 99.5%

### 效能指標
- 平均處理時間：< 8 秒
- P95 回應時間：< 10 秒
- 錯誤率：< 2%

### 使用者滿意度
- 使用者回報的錯誤辨識：< 5%
- 平均每日活躍使用者：> 100
- 使用者留存率：> 60%（月）

## 部署架構

### 基礎設施
- **平台**: Zeabur
- **容器**: Docker
- **網頁框架**: Flask
- **部署 URL**: https://namecard-app.zeabur.app

### CI/CD 流程
1. **測試階段**: 執行單元測試和整合測試
2. **安全掃描**: Bandit、Safety 檢查
3. **部署階段**: 自動部署至 Zeabur
4. **驗證階段**: 健康檢查和效能測試

### 環境變數
**必要**:
- `LINE_CHANNEL_ACCESS_TOKEN`
- `LINE_CHANNEL_SECRET`
- `GOOGLE_API_KEY`（含備援 `GOOGLE_API_KEY_FALLBACK`）
- `NOTION_API_KEY`
- `NOTION_DATABASE_ID`
- `SECRET_KEY`

**選用**:
- `RATE_LIMIT_PER_USER` (預設: 50)
- `BATCH_SIZE_LIMIT` (預設: 10)
- `MAX_IMAGE_SIZE` (預設: 10485760)
- `SENTRY_DSN`

## 不在範圍內

以下功能暫不包含在當前版本：
- 名片匯出功能（Excel、PDF）
- 名片編輯介面
- 多語言介面（僅支援繁體中文）
- 名片去重功能
- OCR 結果人工校正
- 名片分類和標籤
- 團隊協作功能
- 名片分享功能
- 統計分析儀表板

## 待解決問題

- [x] 如何處理多語言名片的語言優先順序？
  - 決策：優先擷取中文資訊，適合台灣市場

- [x] Gemini 2.5 Flash 安全過濾過於嚴格的問題？
  - 決策：配置寬鬆的安全設定，並自動降級至 1.5 Flash

- [ ] 是否需要實作 Redis 作為會話儲存？
  - 待評估：目前記憶體儲存足夠，未來可擴展

- [ ] 是否需要實作名片去重機制？
  - 待評估：用戶行為數據顯示需求不高

- [ ] 是否需要支援名片編輯功能？
  - 待評估：可直接在 Notion 中編輯

## 維護與監控

### 定期檢查
- 每月測試 LINE Bot 和 Notion 功能
- 監控 GitHub Actions CI/CD 流程
- 檢查應用程式日誌中的錯誤
- 驗證 Sentry 告警設定

### 健康檢查端點
- `/health` - 系統健康狀態
- `/test` - 系統設定檢查
- `/debug/notion` - Notion 欄位驗證

### 故障排除
1. 服務異常 → 檢查 `/health` 端點
2. Notion 儲存失敗 → 檢查 `/debug/notion`
3. 部署失敗 → 檢查 GitHub Actions 日誌
4. Sentry 設定問題 → 執行 `python debug-sentry.py`
