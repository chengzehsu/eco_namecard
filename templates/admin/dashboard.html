{% extends "layout.html" %}

{% block title %}儀表板{% endblock %}

{% block content %}
<div class="page-header">
    <h1>儀表板</h1>
    <a href="{{ url_for('admin.create_tenant') }}" class="btn btn-primary">
        <i data-lucide="plus" style="width: 16px; height: 16px;"></i>
        新增租戶
    </a>
</div>

<!-- Time Period Selector -->
<div class="period-selector" style="margin-bottom: 20px;">
    <a href="?period=day" class="period-btn {% if current_period == 'day' %}active{% endif %}">
        <i data-lucide="calendar" style="width: 14px; height: 14px;"></i>
        今日
    </a>
    <a href="?period=week" class="period-btn {% if current_period == 'week' %}active{% endif %}">
        <i data-lucide="calendar-days" style="width: 14px; height: 14px;"></i>
        本週
    </a>
    <a href="?period=month" class="period-btn {% if current_period == 'month' %}active{% endif %}">
        <i data-lucide="calendar-range" style="width: 14px; height: 14px;"></i>
        本月
    </a>
</div>

<!-- Statistics Cards -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon">
            <i data-lucide="users" style="width: 24px; height: 24px;"></i>
        </div>
        <div class="number">{{ stats.total_tenants }}</div>
        <div class="label">活躍租戶</div>
    </div>
    <div class="stat-card">
        <div class="stat-icon">
            <i data-lucide="scan" style="width: 24px; height: 24px;"></i>
        </div>
        <div class="number">{{ all_tenants_summary.total_processed }}</div>
        <div class="label">
            {% if current_period == 'day' %}今日{% elif current_period == 'week' %}本週{% else %}本月{% endif %}處理
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon" style="color: var(--success);">
            <i data-lucide="database" style="width: 24px; height: 24px;"></i>
        </div>
        <div class="number" style="color: var(--success);">{{ all_tenants_summary.total_saved }}</div>
        <div class="label">
            {% if current_period == 'day' %}今日{% elif current_period == 'week' %}本週{% else %}本月{% endif %}儲存
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon" style="color: var(--danger);">
            <i data-lucide="alert-circle" style="width: 24px; height: 24px;"></i>
        </div>
        <div class="number" style="{% if all_tenants_summary.total_errors > 0 %}color: var(--danger);{% endif %}">{{ all_tenants_summary.total_errors }}</div>
        <div class="label">
            {% if current_period == 'day' %}今日{% elif current_period == 'week' %}本週{% else %}本月{% endif %}錯誤
        </div>
    </div>
</div>

<!-- Tenants Overview -->
<div class="card">
    <h2>
        <i data-lucide="activity" style="width: 16px; height: 16px; margin-right: 8px; vertical-align: middle;"></i>
        租戶使用狀況
    </h2>
    {% if tenants %}
    <table>
        <thead>
            <tr>
                <th>名稱</th>
                <th>狀態</th>
                <th style="text-align: center;">今日處理</th>
                <th style="text-align: center;">今日儲存</th>
                <th style="text-align: center;">今日錯誤</th>
                <th style="text-align: center;">每日限制</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            {% for tenant in tenants %}
            {% set t_stats = (tenant_stats or {}).get(tenant.id, {'cards_processed': 0, 'cards_saved': 0, 'errors': 0}) %}
            <tr>
                <td>
                    <strong style="color: var(--text-primary);">{{ tenant.name }}</strong>
                    <br><small style="color: var(--text-muted);">{{ tenant.slug }}</small>
                </td>
                <td>
                    {% if tenant.is_active %}
                    <span class="badge badge-success">
                        <i data-lucide="check-circle" style="width: 12px; height: 12px; margin-right: 4px;"></i>
                        啟用
                    </span>
                    {% else %}
                    <span class="badge badge-danger">
                        <i data-lucide="x-circle" style="width: 12px; height: 12px; margin-right: 4px;"></i>
                        停用
                    </span>
                    {% endif %}
                </td>
                <td style="text-align: center;">
                    <span class="{% if t_stats.cards_processed > 0 %}text-accent{% else %}text-muted{% endif %}">
                        {{ t_stats.cards_processed }}
                    </span>
                </td>
                <td style="text-align: center;">
                    <span class="{% if t_stats.cards_saved > 0 %}text-success{% else %}text-muted{% endif %}">
                        {{ t_stats.cards_saved }}
                    </span>
                </td>
                <td style="text-align: center;">
                    <span class="{% if t_stats.errors > 0 %}text-danger{% else %}text-muted{% endif %}">
                        {{ t_stats.errors }}
                    </span>
                </td>
                <td style="text-align: center; color: var(--text-secondary);">{{ tenant.daily_card_limit }}</td>
                <td class="actions">
                    <a href="{{ url_for('admin.edit_tenant', tenant_id=tenant.id) }}" class="btn btn-secondary btn-sm">
                        <i data-lucide="edit-2" style="width: 14px; height: 14px;"></i>
                        編輯
                    </a>
                    <a href="{{ url_for('admin.tenant_stats', tenant_id=tenant.id) }}" class="btn btn-primary btn-sm">
                        <i data-lucide="bar-chart-2" style="width: 14px; height: 14px;"></i>
                        統計
                    </a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty-state">
        <div class="empty-state-icon">
            <i data-lucide="inbox" style="width: 48px; height: 48px;"></i>
        </div>
        <h3>尚無租戶</h3>
        <p>點擊上方「新增租戶」按鈕開始設定</p>
        <a href="{{ url_for('admin.create_tenant') }}" class="btn btn-primary" style="margin-top: 16px;">
            <i data-lucide="plus" style="width: 16px; height: 16px;"></i>
            建立第一個租戶
        </a>
    </div>
    {% endif %}
</div>

<style>
/* Period Selector */
.period-selector {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.period-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 16px;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    color: var(--text-secondary);
    text-decoration: none;
    font-size: 0.9rem;
    transition: all 0.2s ease;
}

.period-btn:hover {
    background: var(--bg-card);
    border-color: var(--accent-purple);
    color: var(--text-primary);
}

.period-btn.active {
    background: linear-gradient(135deg, var(--accent-purple), var(--accent-blue));
    border-color: transparent;
    color: white;
}
</style>
{% endblock %}

{% block scripts %}
<script>
    // Initialize Lucide icons
    lucide.createIcons();
</script>
{% endblock %}
