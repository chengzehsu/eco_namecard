{% extends "layout.html" %}

{% block title %}租戶管理{% endblock %}

{% block content %}
<div class="page-header">
    <h1>租戶管理</h1>
    <a href="{{ url_for('admin.create_tenant') }}" class="btn btn-primary">+ 新增租戶</a>
</div>

<div class="card">
    {% if tenants %}
    <table>
        <thead>
            <tr>
                <th>名稱</th>
                <th>狀態</th>
                <th>LINE Channel ID</th>
                <th>Notion Database</th>
                <th>Google API</th>
                <th>限制</th>
                <th>建立時間</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            {% for tenant in tenants %}
            <tr>
                <td>
                    <strong>{{ tenant.name }}</strong>
                    <br><small style="color: #7f8c8d;">{{ tenant.slug }}</small>
                </td>
                <td>
                    {% if tenant.is_active %}
                    <span class="badge badge-success">啟用</span>
                    {% else %}
                    <span class="badge badge-danger">停用</span>
                    {% endif %}
                </td>
                <td><code style="font-size: 0.8rem;">{{ tenant.line_channel_id[:12] }}...</code></td>
                <td><code style="font-size: 0.8rem;">{{ tenant.notion_database_id[:8] }}...</code></td>
                <td>
                    {% if tenant.use_shared_google_api %}
                    <span style="color: #7f8c8d;">共用</span>
                    {% else %}
                    <span style="color: #27ae60;">專用</span>
                    {% endif %}
                </td>
                <td>{{ tenant.daily_card_limit }}/天</td>
                <td style="font-size: 0.85rem; color: #7f8c8d;">
                    {{ tenant.created_at.strftime('%Y-%m-%d') if tenant.created_at else '-' }}
                </td>
                <td class="actions">
                    <a href="{{ url_for('admin.edit_tenant', tenant_id=tenant.id) }}" class="btn btn-secondary btn-sm">編輯</a>
                    <a href="{{ url_for('admin.tenant_stats', tenant_id=tenant.id) }}" class="btn btn-primary btn-sm">統計</a>
                    <button onclick="testConnection('{{ tenant.id }}')" class="btn btn-success btn-sm">測試</button>
                    {% if tenant.is_active %}
                    <button onclick="deactivateTenant('{{ tenant.id }}', '{{ tenant.name }}')" class="btn btn-warning btn-sm">停用</button>
                    {% else %}
                    <button onclick="activateTenant('{{ tenant.id }}', '{{ tenant.name }}')" class="btn btn-success btn-sm">啟用</button>
                    {% endif %}
                    <button onclick="deleteTenant('{{ tenant.id }}', '{{ tenant.name }}')" class="btn btn-danger btn-sm">刪除</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="text-align: center; color: #7f8c8d; padding: 40px;">
        尚無租戶。點擊上方「新增租戶」按鈕開始設定。
    </p>
    {% endif %}
</div>

<!-- Test Connection Modal -->
<div id="testModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="background: white; max-width: 500px; margin: 100px auto; padding: 30px; border-radius: 8px;">
        <h3 style="margin-bottom: 20px;">連線測試結果</h3>
        <div id="testResults"></div>
        <button onclick="closeTestModal()" class="btn btn-secondary" style="margin-top: 20px;">關閉</button>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
function testConnection(tenantId) {
    document.getElementById('testModal').style.display = 'block';
    document.getElementById('testResults').innerHTML = '<p>測試中...</p>';

    fetch('/admin/api/tenants/' + tenantId + '/test', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        let html = '';
        for (const [service, result] of Object.entries(data)) {
            const icon = result.status === 'success' ? '✅' : (result.status === 'skipped' ? '⏭️' : '❌');
            const msg = result.message || result.bot_name || result.database_title || '';
            html += `<p><strong>${icon} ${service.toUpperCase()}</strong>: ${result.status} ${msg ? '- ' + msg : ''}</p>`;
        }
        document.getElementById('testResults').innerHTML = html;
    })
    .catch(error => {
        document.getElementById('testResults').innerHTML = '<p style="color: red;">測試失敗: ' + error + '</p>';
    });
}

function closeTestModal() {
    document.getElementById('testModal').style.display = 'none';
}

function deactivateTenant(tenantId, tenantName) {
    if (confirm(`確定要停用租戶「${tenantName}」嗎？\n\n停用後該租戶的 LINE Bot 將無法使用。`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/admin/tenants/${tenantId}/delete`;
        document.body.appendChild(form);
        form.submit();
    }
}

function activateTenant(tenantId, tenantName) {
    if (confirm(`確定要重新啟用租戶「${tenantName}」嗎？`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/admin/tenants/${tenantId}/activate`;
        document.body.appendChild(form);
        form.submit();
    }
}

function deleteTenant(tenantId, tenantName) {
    if (confirm(`⚠️ 警告：確定要永久刪除租戶「${tenantName}」嗎？\n\n此操作無法復原！所有資料將被永久刪除。`)) {
        if (confirm(`再次確認：真的要永久刪除「${tenantName}」嗎？`)) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/admin/tenants/${tenantId}/delete`;

            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'hard_delete';
            input.value = 'true';
            form.appendChild(input);

            document.body.appendChild(form);
            form.submit();
        }
    }
}
</script>
{% endblock %}
