{% extends "layout.html" %}

{% block title %}{{ '編輯租戶' if is_edit else '新增租戶' }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1>
        <i data-lucide="{{ 'edit-2' if is_edit else 'plus-circle' }}" style="width: 24px; height: 24px; margin-right: 8px;"></i>
        {{ '編輯租戶' if is_edit else '新增租戶' }}
    </h1>
    <a href="{{ url_for('admin.list_tenants') }}" class="btn btn-secondary">
        <i data-lucide="arrow-left" style="width: 16px; height: 16px;"></i>
        返回列表
    </a>
</div>

<div class="card">
    <form id="tenant-form" method="POST" action="{{ url_for('admin.edit_tenant', tenant_id=tenant.id) if is_edit else url_for('admin.create_tenant') }}">

        <!-- Basic Info -->
        <h2>
            <i data-lucide="info" style="width: 16px; height: 16px; margin-right: 8px; vertical-align: middle;"></i>
            基本資訊
        </h2>

        <div class="form-group">
            <label for="name">租戶名稱 *</label>
            <input type="text" id="name" name="name" value="{{ tenant.name if tenant else '' }}" required placeholder="例如：小明的名片Bot">
            <small>顯示在管理後台的名稱</small>
        </div>

        {% if is_edit %}
        <div class="form-group">
            <label>識別碼 (Slug)</label>
            <input type="text" value="{{ tenant.slug }}" disabled style="opacity: 0.6;">
            <small>建立後無法修改</small>
        </div>

        <div class="form-group form-check">
            <input type="checkbox" id="is_active" name="is_active" {{ 'checked' if tenant.is_active else '' }}>
            <label for="is_active">啟用租戶</label>
        </div>
        {% else %}
        <div class="form-group">
            <label for="slug">識別碼 (Slug)</label>
            <input type="text" id="slug" name="slug" value="" placeholder="自動產生">
            <small>URL 友善的識別碼，留空將自動產生</small>
        </div>
        {% endif %}

        <!-- LINE Bot Config -->
        <h2 style="margin-top: 30px;">
            <i data-lucide="message-circle" style="width: 16px; height: 16px; margin-right: 8px; vertical-align: middle;"></i>
            LINE Bot 設定
        </h2>

        <div class="form-group">
            <label for="line_channel_id">LINE Bot User ID {{ '' if not is_edit else '' }}</label>
            <input type="text" id="line_channel_id" name="line_channel_id"
                   value="{{ tenant.line_channel_id if tenant and tenant.line_channel_id else '' }}"
                   placeholder="留空可自動偵測（發送訊息給 Bot 後自動綁定）">
            <small>
                {% if is_edit %}
                    {% if tenant.line_channel_id %}
                        ✓ 已綁定
                    {% else %}
                        等待自動偵測中...
                    {% endif %}
                {% else %}
                    <strong style="color: var(--accent-purple);">可選填</strong> — 留空則在首次收到訊息時自動綁定 Bot User ID
                {% endif %}
            </small>
        </div>

        <div class="form-group">
            <label for="line_channel_access_token">Channel Access Token {{ '*' if not is_edit else '' }}</label>
            <input type="password" id="line_channel_access_token" name="line_channel_access_token"
                   {{ 'required' if not is_edit else '' }}
                   placeholder="{{ '已設定 (留空保持不變)' if is_edit else '在 LINE Developers Console 取得' }}">
            <small>Messaging API → Channel access token (long-lived)</small>
        </div>

        <div class="form-group">
            <label for="line_channel_secret">Channel Secret {{ '*' if not is_edit else '' }}</label>
            <input type="password" id="line_channel_secret" name="line_channel_secret"
                   {{ 'required' if not is_edit else '' }}
                   placeholder="{{ '已設定 (留空保持不變)' if is_edit else '在 LINE Developers Console 取得' }}">
            <small>Messaging API → Channel secret</small>
        </div>

        <!-- Notion Config -->
        <h2 style="margin-top: 30px;">
            <i data-lucide="database" style="width: 16px; height: 16px; margin-right: 8px; vertical-align: middle;"></i>
            Notion 設定
        </h2>

        <div class="form-group form-check">
            <input type="checkbox" id="use_shared_notion_api" name="use_shared_notion_api"
                   {{ 'checked' if (not tenant or tenant.use_shared_notion_api) else '' }}
                   onchange="toggleNotionApiKey()">
            <label for="use_shared_notion_api">使用共用 Notion API Key</label>
            <small style="display: block; margin-left: 26px; color: var(--text-muted);">建議開啟，使用系統的 Notion API</small>
        </div>

        <div class="form-group" id="notion_api_key_group" {% if not tenant or tenant.use_shared_notion_api %}hidden{% endif %}>
            <label for="notion_api_key">Notion API Key</label>
            <input type="password" id="notion_api_key" name="notion_api_key"
                   placeholder="{{ '已設定 (留空保持不變)' if is_edit and tenant.notion_api_key else 'secret_xxxxxx...' }}">
            <small>在 <a href="https://www.notion.so/my-integrations" target="_blank" style="color: var(--accent-purple);">Notion Integrations</a> 建立並取得</small>
        </div>

        {% if not is_edit %}
        <div class="form-group form-check">
            <input type="checkbox" id="auto_create_notion_db" name="auto_create_notion_db" checked
                   onchange="toggleNotionDbInput()">
            <label for="auto_create_notion_db">自動創建 Notion 資料庫</label>
            <small style="display: block; margin-left: 26px; color: var(--text-muted);">
                系統將自動創建「{租戶名稱}的名片盒」資料庫，包含所有必要欄位
            </small>
        </div>
        {% endif %}

        <div class="form-group" id="notion_database_id_group" {% if not is_edit %}hidden{% endif %}>
            <label for="notion_database_id">Notion Database ID {{ '*' if is_edit else '' }}</label>
            <input type="text" id="notion_database_id" name="notion_database_id"
                   value="{{ tenant.notion_database_id if tenant else '' }}"
                   {% if is_edit %}required{% endif %}
                   placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx">
            <small>
                {% if is_edit %}
                    Database URL 中的 ID 部分
                {% else %}
                    若不自動創建，請填入現有資料庫 ID
                {% endif %}
            </small>
        </div>

        <!-- Google AI Config -->
        <h2 style="margin-top: 30px;">
            <i data-lucide="sparkles" style="width: 16px; height: 16px; margin-right: 8px; vertical-align: middle;"></i>
            Google AI 設定
        </h2>

        <div class="form-group form-check">
            <input type="checkbox" id="use_shared_google_api" name="use_shared_google_api"
                   {{ 'checked' if (not tenant or tenant.use_shared_google_api) else '' }}
                   onchange="toggleGoogleApiKey()">
            <label for="use_shared_google_api">使用共用 Google API Key</label>
            <small style="display: block; margin-left: 26px; color: var(--text-muted);">建議開啟，使用系統的 Google Gemini API</small>
        </div>

        <div class="form-group" id="google_api_key_group" {% if not tenant or tenant.use_shared_google_api %}hidden{% endif %}>
            <label for="google_api_key">Google API Key</label>
            <input type="password" id="google_api_key" name="google_api_key"
                   placeholder="{{ '已設定 (留空保持不變)' if is_edit and tenant.google_api_key else 'AIza...' }}">
            <small>租戶專用的 Google Gemini API Key</small>
        </div>

        <!-- Limits -->
        <h2 style="margin-top: 30px;">
            <i data-lucide="gauge" style="width: 16px; height: 16px; margin-right: 8px; vertical-align: middle;"></i>
            使用限制
        </h2>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div class="form-group">
                <label for="daily_card_limit">每日名片上限</label>
                <input type="number" id="daily_card_limit" name="daily_card_limit"
                       value="{{ tenant.daily_card_limit if tenant else 50 }}" min="1" max="1000">
                <small>每個用戶每天可處理的名片數量</small>
            </div>

            <div class="form-group">
                <label for="batch_size_limit">批次大小上限</label>
                <input type="number" id="batch_size_limit" name="batch_size_limit"
                       value="{{ tenant.batch_size_limit if tenant else 10 }}" min="1" max="50">
                <small>批次模式中的最大名片數量</small>
            </div>
        </div>
    </form>

    <!-- Actions (outside form to avoid nesting) -->
    <div style="margin-top: 30px; display: flex; gap: 10px;">
        <button type="submit" form="tenant-form" class="btn btn-primary">
            <i data-lucide="{{ 'save' if is_edit else 'plus' }}" style="width: 16px; height: 16px;"></i>
            {{ '儲存變更' if is_edit else '建立租戶' }}
        </button>
        <a href="{{ url_for('admin.list_tenants') }}" class="btn btn-secondary">
            <i data-lucide="x" style="width: 16px; height: 16px;"></i>
            取消
        </a>

        {% if is_edit %}
        <form method="POST" action="{{ url_for('admin.delete_tenant', tenant_id=tenant.id) }}"
              style="margin-left: auto;"
              onsubmit="return confirm('確定要停用此租戶嗎？');">
            <button type="submit" class="btn btn-danger">
                <i data-lucide="pause-circle" style="width: 16px; height: 16px;"></i>
                停用租戶
            </button>
        </form>
        {% endif %}
    </div>
</div>

{% if is_edit %}
<!-- Webhook Info -->
<div class="card" style="margin-top: 20px;">
    <h2>
        <i data-lucide="link" style="width: 16px; height: 16px; margin-right: 8px; vertical-align: middle;"></i>
        Webhook 設定說明
    </h2>
    <p style="color: var(--text-muted);">請在 LINE Developers Console 中設定以下 Webhook URL：</p>
    <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; margin-top: 10px; border: 1px solid var(--border-color);">
        <code style="font-size: 1rem; color: var(--accent-purple);">https://namecard-app.zeabur.app/callback</code>
    </div>
    <p style="color: var(--text-muted); margin-top: 10px; font-size: 0.9rem;">
        <i data-lucide="info" style="width: 14px; height: 14px; margin-right: 4px; vertical-align: middle;"></i>
        所有租戶使用相同的 Webhook URL，系統會根據 Bot User ID 自動識別租戶。
    </p>
</div>
{% endif %}

<script>
function toggleGoogleApiKey() {
    const checkbox = document.getElementById('use_shared_google_api');
    const group = document.getElementById('google_api_key_group');
    group.hidden = checkbox.checked;
}

function toggleNotionApiKey() {
    const checkbox = document.getElementById('use_shared_notion_api');
    const group = document.getElementById('notion_api_key_group');
    group.hidden = checkbox.checked;
}

function toggleNotionDbInput() {
    const checkbox = document.getElementById('auto_create_notion_db');
    const group = document.getElementById('notion_database_id_group');
    const input = document.getElementById('notion_database_id');
    if (checkbox) {
        group.hidden = checkbox.checked;
        input.required = !checkbox.checked;
    }
}
</script>
{% endblock %}
