{% extends "layout.html" %}

{% block title %}租戶管理{% endblock %}

{% block content %}
<div class="page-header">
    <h1>租戶管理</h1>
    <a href="{{ url_for('admin.create_tenant') }}" class="btn btn-primary">
        <i data-lucide="plus" style="width: 16px; height: 16px;"></i>
        新增租戶
    </a>
</div>

<div class="card">
    {% if tenants %}
    <table>
        <thead>
            <tr>
                <th>名稱</th>
                <th>狀態</th>
                <th>LINE Channel ID</th>
                <th>Notion Database</th>
                <th>Google API</th>
                <th>限制</th>
                <th>建立時間</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            {% for tenant in tenants %}
            <tr>
                <td>
                    <strong style="color: var(--text-primary);">{{ tenant.name }}</strong>
                    <br><small style="color: var(--text-muted);">{{ tenant.slug }}</small>
                </td>
                <td>
                    {% if not tenant.is_active %}
                    <span class="badge badge-danger">
                        <i data-lucide="x-circle" style="width: 12px; height: 12px; margin-right: 4px;"></i>
                        停用
                    </span>
                    {% elif tenant.activation_status == 'pending' %}
                    <span class="badge" style="background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: #1a1a1a;">
                        <i data-lucide="clock" style="width: 12px; height: 12px; margin-right: 4px;"></i>
                        待綁定
                    </span>
                    {% else %}
                    <span class="badge badge-success">
                        <i data-lucide="check-circle" style="width: 12px; height: 12px; margin-right: 4px;"></i>
                        啟用
                    </span>
                    {% endif %}
                </td>
                <td>
                    {% if tenant.line_channel_id %}
                    <code>{{ tenant.line_channel_id[:12] }}...</code>
                    {% else %}
                    <span style="color: var(--text-muted); font-style: italic;">
                        <i data-lucide="clock" style="width: 12px; height: 12px; margin-right: 4px; vertical-align: middle;"></i>
                        等待自動偵測
                    </span>
                    {% endif %}
                </td>
                <td>
                    <code>{{ tenant.notion_database_id[:8] }}...</code>
                    <br>
                    {% if tenant.use_shared_notion_api %}
                    <small style="color: var(--text-muted);">
                        <i data-lucide="share-2" style="width: 10px; height: 10px;"></i> 共用 API
                    </small>
                    {% else %}
                    <small style="color: var(--success);">
                        <i data-lucide="key" style="width: 10px; height: 10px;"></i> 專用 API
                    </small>
                    {% endif %}
                </td>
                <td>
                    {% if tenant.use_shared_google_api %}
                    <span style="color: var(--text-muted);">
                        <i data-lucide="share-2" style="width: 14px; height: 14px; margin-right: 4px;"></i>
                        共用
                    </span>
                    {% else %}
                    <span style="color: var(--success);">
                        <i data-lucide="key" style="width: 14px; height: 14px; margin-right: 4px;"></i>
                        專用
                    </span>
                    {% endif %}
                </td>
                <td style="color: var(--text-secondary);">{{ tenant.daily_card_limit }}/天</td>
                <td style="color: var(--text-muted);">
                    {{ tenant.created_at.strftime('%Y-%m-%d') if tenant.created_at else '-' }}
                </td>
                <td class="actions">
                    <a href="{{ url_for('admin.edit_tenant', tenant_id=tenant.id) }}" class="btn btn-secondary btn-sm">
                        <i data-lucide="edit-2" style="width: 14px; height: 14px;"></i>
                        編輯
                    </a>
                    <a href="{{ url_for('admin.tenant_stats', tenant_id=tenant.id) }}" class="btn btn-primary btn-sm">
                        <i data-lucide="bar-chart-2" style="width: 14px; height: 14px;"></i>
                        統計
                    </a>
                    <button onclick="testConnection('{{ tenant.id }}')" class="btn btn-success btn-sm">
                        <i data-lucide="wifi" style="width: 14px; height: 14px;"></i>
                        測試
                    </button>
                    {% if tenant.is_active %}
                    <button onclick="deactivateTenant('{{ tenant.id }}', '{{ tenant.name }}')" class="btn btn-warning btn-sm">
                        <i data-lucide="pause-circle" style="width: 14px; height: 14px;"></i>
                        停用
                    </button>
                    {% else %}
                    <button onclick="activateTenant('{{ tenant.id }}', '{{ tenant.name }}')" class="btn btn-success btn-sm">
                        <i data-lucide="play-circle" style="width: 14px; height: 14px;"></i>
                        啟用
                    </button>
                    {% endif %}
                    <button onclick="deleteTenant('{{ tenant.id }}', '{{ tenant.name }}')" class="btn btn-danger btn-sm">
                        <i data-lucide="trash-2" style="width: 14px; height: 14px;"></i>
                        刪除
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty-state">
        <div class="empty-state-icon">
            <i data-lucide="building-2" style="width: 48px; height: 48px;"></i>
        </div>
        <h3>尚無租戶</h3>
        <p>點擊上方「新增租戶」按鈕開始設定</p>
        <a href="{{ url_for('admin.create_tenant') }}" class="btn btn-primary" style="margin-top: 16px;">
            <i data-lucide="plus" style="width: 16px; height: 16px;"></i>
            建立第一個租戶
        </a>
    </div>
    {% endif %}
</div>

<!-- Test Connection Modal -->
<div id="testModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); z-index: 1000;">
    <div style="background: var(--bg-secondary); border: 1px solid var(--border-color); max-width: 500px; margin: 100px auto; padding: 28px; border-radius: 14px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);">
        <h3 style="margin-bottom: 20px; color: var(--text-primary); font-weight: 600; display: flex; align-items: center; gap: 10px;">
            <i data-lucide="wifi" style="width: 20px; height: 20px;"></i>
            連線測試結果
        </h3>
        <div id="testResults" style="color: var(--text-secondary);"></div>
        <button onclick="closeTestModal()" class="btn btn-secondary" style="margin-top: 20px;">
            <i data-lucide="x" style="width: 16px; height: 16px;"></i>
            關閉
        </button>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
function testConnection(tenantId) {
    document.getElementById('testModal').style.display = 'block';
    document.getElementById('testResults').innerHTML = '<p style="display: flex; align-items: center; gap: 8px;"><span class="loading-spinner"></span> 測試中...</p>';

    // Re-initialize icons for modal
    lucide.createIcons();

    fetch('/admin/api/tenants/' + tenantId + '/test', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        let html = '<div style="display: flex; flex-direction: column; gap: 12px;">';
        for (const [service, result] of Object.entries(data)) {
            const isSuccess = result.status === 'success';
            const isSkipped = result.status === 'skipped';
            const iconName = isSuccess ? 'check-circle' : (isSkipped ? 'minus-circle' : 'x-circle');
            const color = isSuccess ? 'var(--success)' : (isSkipped ? 'var(--text-muted)' : 'var(--danger)');
            const msg = result.message || result.bot_name || result.database_title || '';
            html += `
                <div style="display: flex; align-items: center; gap: 10px; padding: 12px; background: var(--bg-card); border-radius: 8px; border: 1px solid var(--border-color);">
                    <i data-lucide="${iconName}" style="width: 20px; height: 20px; color: ${color};"></i>
                    <div>
                        <strong style="color: var(--text-primary);">${service.toUpperCase()}</strong>
                        <span style="color: ${color}; margin-left: 8px;">${result.status}</span>
                        ${msg ? `<br><small style="color: var(--text-muted);">${msg}</small>` : ''}
                    </div>
                </div>
            `;
        }
        html += '</div>';
        document.getElementById('testResults').innerHTML = html;
        lucide.createIcons();
    })
    .catch(error => {
        document.getElementById('testResults').innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px; color: var(--danger);">
                <i data-lucide="alert-triangle" style="width: 20px; height: 20px;"></i>
                測試失敗: ${error}
            </div>
        `;
        lucide.createIcons();
    });
}

function closeTestModal() {
    document.getElementById('testModal').style.display = 'none';
}

function deactivateTenant(tenantId, tenantName) {
    if (confirm(`確定要停用租戶「${tenantName}」嗎？\n\n停用後該租戶的 LINE Bot 將無法使用。`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/admin/tenants/${tenantId}/delete`;
        document.body.appendChild(form);
        form.submit();
    }
}

function activateTenant(tenantId, tenantName) {
    if (confirm(`確定要重新啟用租戶「${tenantName}」嗎？`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/admin/tenants/${tenantId}/activate`;
        document.body.appendChild(form);
        form.submit();
    }
}

function deleteTenant(tenantId, tenantName) {
    if (confirm(`⚠️ 警告：確定要永久刪除租戶「${tenantName}」嗎？\n\n此操作無法復原！所有資料將被永久刪除。`)) {
        if (confirm(`再次確認：真的要永久刪除「${tenantName}」嗎？`)) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/admin/tenants/${tenantId}/delete`;

            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'hard_delete';
            input.value = 'true';
            form.appendChild(input);

            document.body.appendChild(form);
            form.submit();
        }
    }
}
</script>
{% endblock %}
