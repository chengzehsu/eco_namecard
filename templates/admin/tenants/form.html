{% extends "layout.html" %}

{% block title %}{{ '編輯租戶' if is_edit else '新增租戶' }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1>
        <i data-lucide="{{ 'edit-2' if is_edit else 'plus-circle' }}" style="width: 24px; height: 24px; margin-right: 8px;"></i>
        {{ '編輯租戶' if is_edit else '新增租戶' }}
    </h1>
    <a href="{{ url_for('admin.list_tenants') }}" class="btn btn-secondary">
        <i data-lucide="arrow-left" style="width: 16px; height: 16px;"></i>
        返回列表
    </a>
</div>

<div class="card">
    <form id="tenant-form" method="POST" action="{{ url_for('admin.edit_tenant', tenant_id=tenant.id) if is_edit else url_for('admin.create_tenant') }}">

        <!-- Basic Info -->
        <h2>
            <i data-lucide="info" style="width: 16px; height: 16px; margin-right: 8px; vertical-align: middle;"></i>
            基本資訊
        </h2>

        <div class="form-group">
            <label for="name">租戶名稱 *</label>
            <input type="text" id="name" name="name" value="{{ tenant.name if tenant else '' }}" required placeholder="例如：小明的名片Bot">
            <small>顯示在管理後台的名稱</small>
        </div>

        {% if is_edit %}
        <div class="form-group">
            <label>識別碼 (Slug)</label>
            <input type="text" value="{{ tenant.slug }}" disabled style="opacity: 0.6;">
            <small>建立後無法修改</small>
        </div>

        <div class="form-group form-check">
            <input type="checkbox" id="is_active" name="is_active" {{ 'checked' if tenant.is_active else '' }}>
            <label for="is_active">啟用租戶</label>
        </div>
        {% else %}
        <div class="form-group">
            <label for="slug">識別碼 (Slug)</label>
            <input type="text" id="slug" name="slug" value="" placeholder="自動產生">
            <small>URL 友善的識別碼，留空將自動產生</small>
        </div>
        {% endif %}

        <!-- LINE Bot Config -->
        <h2 style="margin-top: 30px;">
            <i data-lucide="message-circle" style="width: 16px; height: 16px; margin-right: 8px; vertical-align: middle;"></i>
            LINE Bot 設定
        </h2>

        <div class="form-group">
            <label for="line_channel_access_token">Channel Access Token *</label>
            <input type="password" id="line_channel_access_token" name="line_channel_access_token"
                   {{ 'required' if not is_edit else '' }}
                   placeholder="{{ '已設定 (留空保持不變)' if is_edit else '在 LINE Developers Console 取得' }}">
            <small>Messaging API → Channel access token (long-lived)</small>
        </div>

        <div class="form-group">
            <label for="line_channel_secret">Channel Secret *</label>
            <input type="password" id="line_channel_secret" name="line_channel_secret"
                   {{ 'required' if not is_edit else '' }}
                   placeholder="{{ '已設定 (留空保持不變)' if is_edit else '在 LINE Developers Console 取得' }}">
            <small>Messaging API → Channel secret</small>
        </div>

        {% if not is_edit %}
        <!-- 獲取 Bot User ID 按鈕 -->
        <div class="form-group">
            <button type="button" id="fetch-bot-id-btn" class="btn btn-secondary" onclick="fetchBotUserId()" style="margin-bottom: 10px;">
                <i data-lucide="search" style="width: 16px; height: 16px;"></i>
                獲取 Bot User ID
            </button>
            <div id="fetch-status" style="display: none; padding: 10px; border-radius: 6px; margin-top: 10px;"></div>
        </div>
        {% endif %}

        <div class="form-group">
            <label for="line_channel_id">LINE Bot User ID {{ '*' if not is_edit else '' }}</label>
            <input type="text" id="line_channel_id" name="line_channel_id"
                   value="{{ tenant.line_channel_id if tenant and tenant.line_channel_id else '' }}"
                   {{ 'readonly' if not is_edit else '' }}
                   placeholder="{{ (tenant.line_channel_id if tenant.line_channel_id else '尚未設定') if is_edit else '點擊上方按鈕獲取' }}"
                   class="{{ 'readonly-input' if not is_edit else '' }}">
            <small>
                {% if is_edit %}
                    {% if tenant.line_channel_id %}
                        ✓ 已綁定
                    {% else %}
                        尚未綁定
                    {% endif %}
                {% else %}
                    請先填入 Channel Access Token，然後點擊「獲取 Bot User ID」按鈕
                {% endif %}
            </small>
        </div>

        <!-- Notion Config -->
        <h2 style="margin-top: 30px;">
            <i data-lucide="database" style="width: 16px; height: 16px; margin-right: 8px; vertical-align: middle;"></i>
            Notion 設定
        </h2>

        <div class="form-group form-check">
            <input type="checkbox" id="use_shared_notion_api" name="use_shared_notion_api"
                   {{ 'checked' if (not tenant or tenant.use_shared_notion_api) else '' }}
                   onchange="toggleNotionApiKey()">
            <label for="use_shared_notion_api">使用共用 Notion API Key</label>
            <small style="display: block; margin-left: 26px; color: var(--text-muted);">建議開啟，使用系統的 Notion API</small>
        </div>

        <div class="form-group" id="notion_api_key_group" {% if not tenant or tenant.use_shared_notion_api %}hidden{% endif %}>
            <label for="notion_api_key">Notion API Key</label>
            <input type="password" id="notion_api_key" name="notion_api_key"
                   placeholder="{{ '已設定 (留空保持不變)' if is_edit and tenant.notion_api_key else 'secret_xxxxxx...' }}">
            <small>在 <a href="https://www.notion.so/my-integrations" target="_blank" style="color: var(--accent-purple);">Notion Integrations</a> 建立並取得</small>
        </div>

        {% if not is_edit %}
        <div class="form-group form-check">
            <input type="checkbox" id="auto_create_notion_db" name="auto_create_notion_db" checked
                   onchange="toggleNotionDbInput()">
            <label for="auto_create_notion_db">自動創建 Notion 資料庫</label>
            <small style="display: block; margin-left: 26px; color: var(--text-muted);">
                系統將自動創建「{租戶名稱}的名片盒」資料庫，包含所有必要欄位
            </small>
        </div>
        {% endif %}

        <div class="form-group" id="notion_database_id_group" {% if not is_edit %}hidden{% endif %}>
            <label for="notion_database_id">Notion Database ID {{ '*' if is_edit else '' }}</label>
            <div class="input-with-button">
                <input type="text" id="notion_database_id" name="notion_database_id"
                       value="{{ tenant.notion_database_id if tenant else '' }}"
                       {% if is_edit %}required{% endif %}
                       placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx">
                <button type="button" onclick="fetchNotionDatabaseInfo()" class="btn btn-secondary">
                    <i data-lucide="search" style="width: 16px; height: 16px;"></i>
                    驗證資料庫
                </button>
            </div>
            <div id="notion_db_status" class="status-message"></div>
            <small>
                {% if is_edit %}
                    Database URL 中的 ID 部分
                {% else %}
                    若不自動創建，請填入現有資料庫 ID
                {% endif %}
            </small>
        </div>

        <!-- Google AI Config -->
        <h2 style="margin-top: 30px;">
            <i data-lucide="sparkles" style="width: 16px; height: 16px; margin-right: 8px; vertical-align: middle;"></i>
            Google AI 設定
        </h2>

        <div class="form-group form-check">
            <input type="checkbox" id="use_shared_google_api" name="use_shared_google_api"
                   {{ 'checked' if (not tenant or tenant.use_shared_google_api) else '' }}
                   onchange="toggleGoogleApiKey()">
            <label for="use_shared_google_api">使用共用 Google API Key</label>
            <small style="display: block; margin-left: 26px; color: var(--text-muted);">建議開啟，使用系統的 Google Gemini API</small>
        </div>

        <div class="form-group" id="google_api_key_group" {% if not tenant or tenant.use_shared_google_api %}hidden{% endif %}>
            <label for="google_api_key">Google API Key</label>
            <input type="password" id="google_api_key" name="google_api_key"
                   placeholder="{{ '已設定 (留空保持不變)' if is_edit and tenant.google_api_key else 'AIza...' }}">
            <small>租戶專用的 Google Gemini API Key</small>
        </div>

        <!-- Limits -->
        <h2 style="margin-top: 30px;">
            <i data-lucide="gauge" style="width: 16px; height: 16px; margin-right: 8px; vertical-align: middle;"></i>
            使用限制
        </h2>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div class="form-group">
                <label for="daily_card_limit">每日名片上限</label>
                <input type="number" id="daily_card_limit" name="daily_card_limit"
                       value="{{ tenant.daily_card_limit if tenant else 50 }}" min="1" max="1000">
                <small>每個用戶每天可處理的名片數量</small>
            </div>

            <div class="form-group">
                <label for="batch_size_limit">批次大小上限</label>
                <input type="number" id="batch_size_limit" name="batch_size_limit"
                       value="{{ tenant.batch_size_limit if tenant else 10 }}" min="1" max="50">
                <small>批次模式中的最大名片數量</small>
            </div>
        </div>
    </form>

    <!-- Actions (outside form to avoid nesting) -->
    <div style="margin-top: 30px; display: flex; gap: 10px;">
        <button type="submit" form="tenant-form" id="submit-btn" class="btn btn-primary"
                {% if not is_edit %}disabled title="請先獲取 Bot User ID"{% endif %}>
            <i data-lucide="{{ 'save' if is_edit else 'plus' }}" style="width: 16px; height: 16px;"></i>
            {{ '儲存變更' if is_edit else '建立租戶' }}
        </button>
        <a href="{{ url_for('admin.list_tenants') }}" class="btn btn-secondary">
            <i data-lucide="x" style="width: 16px; height: 16px;"></i>
            取消
        </a>

        {% if is_edit %}
        <form method="POST" action="{{ url_for('admin.delete_tenant', tenant_id=tenant.id) }}"
              style="margin-left: auto;"
              onsubmit="return confirm('確定要停用此租戶嗎？');">
            <button type="submit" class="btn btn-danger">
                <i data-lucide="pause-circle" style="width: 16px; height: 16px;"></i>
                停用租戶
            </button>
        </form>
        {% endif %}
    </div>
</div>

{% if is_edit %}
<!-- Webhook Info -->
<div class="card" style="margin-top: 20px;">
    <h2>
        <i data-lucide="link" style="width: 16px; height: 16px; margin-right: 8px; vertical-align: middle;"></i>
        Webhook 設定說明
    </h2>
    <p style="color: var(--text-muted);">請在 LINE Developers Console 中設定以下 Webhook URL：</p>
    <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; margin-top: 10px; border: 1px solid var(--border-color);">
        <code style="font-size: 1rem; color: var(--accent-purple);">https://eco-namecard.zeabur.app/callback</code>
    </div>
    <p style="color: var(--text-muted); margin-top: 10px; font-size: 0.9rem;">
        <i data-lucide="info" style="width: 14px; height: 14px; margin-right: 4px; vertical-align: middle;"></i>
        所有租戶使用相同的 Webhook URL，系統會根據 Bot User ID 自動識別租戶。
    </p>
</div>
{% endif %}

<script>
function toggleGoogleApiKey() {
    const checkbox = document.getElementById('use_shared_google_api');
    const group = document.getElementById('google_api_key_group');
    group.hidden = checkbox.checked;
}

function toggleNotionApiKey() {
    const checkbox = document.getElementById('use_shared_notion_api');
    const group = document.getElementById('notion_api_key_group');
    group.hidden = checkbox.checked;
}

function toggleNotionDbInput() {
    const checkbox = document.getElementById('auto_create_notion_db');
    const group = document.getElementById('notion_database_id_group');
    const input = document.getElementById('notion_database_id');
    if (checkbox) {
        group.hidden = checkbox.checked;
        input.required = !checkbox.checked;
    }
}

// 驗證 Notion Database
async function fetchNotionDatabaseInfo() {
    const databaseIdInput = document.getElementById('notion_database_id');
    const notionApiKeyInput = document.getElementById('notion_api_key');
    const useSharedApiCheckbox = document.getElementById('use_shared_notion_api');
    const statusDiv = document.getElementById('notion_db_status');
    const verifyBtn = event.target.closest('button');

    const databaseId = databaseIdInput.value.trim();
    const notionApiKey = notionApiKeyInput ? notionApiKeyInput.value.trim() : '';
    const useSharedApi = useSharedApiCheckbox ? useSharedApiCheckbox.checked : false;

    // 驗證輸入
    if (!databaseId) {
        statusDiv.className = 'status-message error';
        statusDiv.innerHTML = '❌ 請先填寫 Database ID';
        return;
    }

    if (!useSharedApi && !notionApiKey) {
        statusDiv.className = 'status-message error';
        statusDiv.innerHTML = '❌ 請先填寫 Notion API Key 或勾選使用共用 API Key';
        return;
    }

    // 顯示載入狀態
    statusDiv.className = 'status-message info';
    statusDiv.innerHTML = '⏳ 正在驗證 Notion Database...';
    verifyBtn.disabled = true;
    verifyBtn.innerHTML = '<i data-lucide="loader" style="width: 16px; height: 16px; animation: spin 1s linear infinite;"></i> 驗證中...';

    try {
        const response = await fetch('{{ url_for("admin.fetch_notion_database_info") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                database_id: databaseId,
                notion_api_key: notionApiKey,
                use_shared_api: useSharedApi,
            }),
        });

        const data = await response.json();

        if (data.success) {
            statusDiv.className = 'status-message success';
            let message = `✅ 驗證成功！<br><strong>資料庫名稱:</strong> ${data.database_title}`;

            // 顯示實際讀取到的欄位
            if (data.actual_fields && data.actual_fields.length > 0) {
                message += `<br><strong>讀取到 ${data.field_count} 個欄位:</strong> ${data.actual_fields.join(', ')}`;
            }

            if (data.warning) {
                message += `<br><span class="status-warning">⚠️ ${data.warning}</span>`;
                if (data.debug_info) {
                    message += `<br><small>${data.debug_info}</small>`;
                }
            }

            statusDiv.innerHTML = message;

            // 自動填入正確的 database_id（無 hyphens）
            databaseIdInput.value = data.database_id;

            // 更新按鈕狀態
            verifyBtn.innerHTML = '<i data-lucide="check" style="width: 16px; height: 16px;"></i> 已驗證';
            verifyBtn.style.background = 'var(--accent-green)';
            verifyBtn.style.borderColor = 'var(--accent-green)';
            verifyBtn.style.color = 'white';
        } else {
            statusDiv.className = 'status-message error';
            statusDiv.innerHTML = `❌ 驗證失敗：${data.error}`;

            verifyBtn.disabled = false;
            verifyBtn.innerHTML = '<i data-lucide="search" style="width: 16px; height: 16px;"></i> 重新驗證';
        }
    } catch (error) {
        statusDiv.className = 'status-message error';
        statusDiv.innerHTML = `❌ 網路錯誤：${error.message}`;

        verifyBtn.disabled = false;
        verifyBtn.innerHTML = '<i data-lucide="search" style="width: 16px; height: 16px;"></i> 重新驗證';
    }

    // 重新初始化 Lucide 圖標
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
}

// 獲取 Bot User ID
async function fetchBotUserId() {
    const accessToken = document.getElementById('line_channel_access_token').value.trim();
    const statusDiv = document.getElementById('fetch-status');
    const botIdInput = document.getElementById('line_channel_id');
    const fetchBtn = document.getElementById('fetch-bot-id-btn');
    const submitBtn = document.getElementById('submit-btn');

    // 驗證 Access Token 是否已填入
    if (!accessToken) {
        statusDiv.style.display = 'block';
        statusDiv.style.background = 'var(--accent-red-bg, #fee2e2)';
        statusDiv.style.color = 'var(--accent-red, #dc2626)';
        statusDiv.style.border = '1px solid var(--accent-red, #dc2626)';
        statusDiv.innerHTML = '⚠️ 請先填入 Channel Access Token';
        return;
    }

    // 顯示載入狀態
    fetchBtn.disabled = true;
    fetchBtn.innerHTML = '<i data-lucide="loader" style="width: 16px; height: 16px; animation: spin 1s linear infinite;"></i> 獲取中...';
    statusDiv.style.display = 'block';
    statusDiv.style.background = 'var(--bg-secondary)';
    statusDiv.style.color = 'var(--text-primary)';
    statusDiv.style.border = '1px solid var(--border-color)';
    statusDiv.innerHTML = '⏳ 正在連接 LINE API...';

    try {
        const response = await fetch('{{ url_for("admin.fetch_bot_user_id") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                access_token: accessToken
            })
        });

        const data = await response.json();

        if (data.success) {
            // 成功獲取
            botIdInput.value = data.bot_user_id;
            statusDiv.style.background = 'var(--accent-green-bg, #dcfce7)';
            statusDiv.style.color = 'var(--accent-green, #16a34a)';
            statusDiv.style.border = '1px solid var(--accent-green, #16a34a)';
            statusDiv.innerHTML = `✓ 成功獲取！<br><strong>Bot User ID:</strong> ${data.bot_user_id}<br><strong>Bot 名稱:</strong> ${data.bot_name || '(未設定)'}`;

            // 啟用提交按鈕
            submitBtn.disabled = false;
            submitBtn.title = '';

            // 更新按鈕狀態
            fetchBtn.innerHTML = '<i data-lucide="check" style="width: 16px; height: 16px;"></i> 已獲取';
            fetchBtn.style.background = 'var(--accent-green)';
            fetchBtn.style.borderColor = 'var(--accent-green)';
            fetchBtn.style.color = 'white';
        } else {
            // 獲取失敗
            statusDiv.style.background = 'var(--accent-red-bg, #fee2e2)';
            statusDiv.style.color = 'var(--accent-red, #dc2626)';
            statusDiv.style.border = '1px solid var(--accent-red, #dc2626)';
            statusDiv.innerHTML = `❌ 獲取失敗：${data.error}`;

            fetchBtn.disabled = false;
            fetchBtn.innerHTML = '<i data-lucide="search" style="width: 16px; height: 16px;"></i> 重新獲取';
        }
    } catch (error) {
        statusDiv.style.background = 'var(--accent-red-bg, #fee2e2)';
        statusDiv.style.color = 'var(--accent-red, #dc2626)';
        statusDiv.style.border = '1px solid var(--accent-red, #dc2626)';
        statusDiv.innerHTML = `❌ 網路錯誤：${error.message}`;

        fetchBtn.disabled = false;
        fetchBtn.innerHTML = '<i data-lucide="search" style="width: 16px; height: 16px;"></i> 重新獲取';
    }

    // 重新初始化 Lucide 圖標
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
}

// 添加 CSS 動畫
const style = document.createElement('style');
style.textContent = `
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}
