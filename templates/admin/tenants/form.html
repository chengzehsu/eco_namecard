{% extends "layout.html" %}

{% block title %}{{ 'ç·¨è¼¯ç§Ÿæˆ¶' if is_edit else 'æ–°å¢ç§Ÿæˆ¶' }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1>
        <i data-lucide="{{ 'edit-2' if is_edit else 'plus-circle' }}" style="width: 24px; height: 24px; margin-right: 8px;"></i>
        {{ 'ç·¨è¼¯ç§Ÿæˆ¶' if is_edit else 'æ–°å¢ç§Ÿæˆ¶' }}
    </h1>
    <a href="{{ url_for('admin.list_tenants') }}" class="btn btn-secondary">
        <i data-lucide="arrow-left" style="width: 16px; height: 16px;"></i>
        è¿”å›åˆ—è¡¨
    </a>
</div>

<div class="card">
    <form id="tenant-form" method="POST" action="{{ url_for('admin.edit_tenant', tenant_id=tenant.id) if is_edit else url_for('admin.create_tenant') }}">

        <!-- Basic Info -->
        <h2>
            <i data-lucide="info" style="width: 16px; height: 16px; margin-right: 8px; vertical-align: middle;"></i>
            åŸºæœ¬è³‡è¨Š
        </h2>

        <div class="form-group">
            <label for="name">ç§Ÿæˆ¶åç¨± *</label>
            <input type="text" id="name" name="name" value="{{ tenant.name if tenant else '' }}" required placeholder="ä¾‹å¦‚ï¼šå°æ˜çš„åç‰‡Bot">
            <small>é¡¯ç¤ºåœ¨ç®¡ç†å¾Œå°çš„åç¨±</small>
        </div>

        {% if is_edit %}
        <div class="form-group">
            <label>è­˜åˆ¥ç¢¼ (Slug)</label>
            <input type="text" value="{{ tenant.slug }}" disabled style="opacity: 0.6;">
            <small>å»ºç«‹å¾Œç„¡æ³•ä¿®æ”¹</small>
        </div>

        <div class="form-group form-check">
            <input type="checkbox" id="is_active" name="is_active" {{ 'checked' if tenant.is_active else '' }}>
            <label for="is_active">å•Ÿç”¨ç§Ÿæˆ¶</label>
        </div>
        {% else %}
        <div class="form-group">
            <label for="slug">è­˜åˆ¥ç¢¼ (Slug)</label>
            <input type="text" id="slug" name="slug" value="" placeholder="è‡ªå‹•ç”¢ç”Ÿ">
            <small>URL å‹å–„çš„è­˜åˆ¥ç¢¼ï¼Œç•™ç©ºå°‡è‡ªå‹•ç”¢ç”Ÿ</small>
        </div>
        {% endif %}

        <!-- LINE Bot Config -->
        <h2 style="margin-top: 30px;">
            <i data-lucide="message-circle" style="width: 16px; height: 16px; margin-right: 8px; vertical-align: middle;"></i>
            LINE Bot è¨­å®š
        </h2>

        <div class="form-group">
            <label for="line_channel_id">LINE Bot User ID</label>
            <input type="text" id="line_channel_id" name="line_channel_id"
                   value="{{ tenant.line_channel_id if tenant and tenant.line_channel_id else '' }}"
                   placeholder="ç•™ç©ºå°‡è‡ªå‹•å¾ LINE API ç²å–">
            <small>
                {% if is_edit %}
                    {% if tenant.line_channel_id %}
                        âœ“ å·²ç¶å®š: {{ tenant.line_channel_id[:20] }}...
                    {% else %}
                        å°šæœªç¶å®š
                    {% endif %}
                {% else %}
                    <strong style="color: var(--accent-green);">ğŸ’¡ è‡ªå‹•ç²å–</strong> â€” ç³»çµ±æœƒä½¿ç”¨ Channel Access Token è‡ªå‹•å¾ LINE API ç²å– Bot User ID
                {% endif %}
            </small>
        </div>

        <div class="form-group">
            <label for="line_channel_access_token">Channel Access Token {{ '*' if not is_edit else '' }}</label>
            <input type="password" id="line_channel_access_token" name="line_channel_access_token"
                   {{ 'required' if not is_edit else '' }}
                   placeholder="{{ 'å·²è¨­å®š (ç•™ç©ºä¿æŒä¸è®Š)' if is_edit else 'åœ¨ LINE Developers Console å–å¾—' }}">
            <small>Messaging API â†’ Channel access token (long-lived)</small>
        </div>

        <div class="form-group">
            <label for="line_channel_secret">Channel Secret {{ '*' if not is_edit else '' }}</label>
            <input type="password" id="line_channel_secret" name="line_channel_secret"
                   {{ 'required' if not is_edit else '' }}
                   placeholder="{{ 'å·²è¨­å®š (ç•™ç©ºä¿æŒä¸è®Š)' if is_edit else 'åœ¨ LINE Developers Console å–å¾—' }}">
            <small>Messaging API â†’ Channel secret</small>
        </div>

        <!-- Notion Config -->
        <h2 style="margin-top: 30px;">
            <i data-lucide="database" style="width: 16px; height: 16px; margin-right: 8px; vertical-align: middle;"></i>
            Notion è¨­å®š
        </h2>

        <div class="form-group form-check">
            <input type="checkbox" id="use_shared_notion_api" name="use_shared_notion_api"
                   {{ 'checked' if (not tenant or tenant.use_shared_notion_api) else '' }}
                   onchange="toggleNotionApiKey()">
            <label for="use_shared_notion_api">ä½¿ç”¨å…±ç”¨ Notion API Key</label>
            <small style="display: block; margin-left: 26px; color: var(--text-muted);">å»ºè­°é–‹å•Ÿï¼Œä½¿ç”¨ç³»çµ±çš„ Notion API</small>
        </div>

        <div class="form-group" id="notion_api_key_group" {% if not tenant or tenant.use_shared_notion_api %}hidden{% endif %}>
            <label for="notion_api_key">Notion API Key</label>
            <input type="password" id="notion_api_key" name="notion_api_key"
                   placeholder="{{ 'å·²è¨­å®š (ç•™ç©ºä¿æŒä¸è®Š)' if is_edit and tenant.notion_api_key else 'secret_xxxxxx...' }}">
            <small>åœ¨ <a href="https://www.notion.so/my-integrations" target="_blank" style="color: var(--accent-purple);">Notion Integrations</a> å»ºç«‹ä¸¦å–å¾—</small>
        </div>

        {% if not is_edit %}
        <div class="form-group form-check">
            <input type="checkbox" id="auto_create_notion_db" name="auto_create_notion_db" checked
                   onchange="toggleNotionDbInput()">
            <label for="auto_create_notion_db">è‡ªå‹•å‰µå»º Notion è³‡æ–™åº«</label>
            <small style="display: block; margin-left: 26px; color: var(--text-muted);">
                ç³»çµ±å°‡è‡ªå‹•å‰µå»ºã€Œ{ç§Ÿæˆ¶åç¨±}çš„åç‰‡ç›’ã€è³‡æ–™åº«ï¼ŒåŒ…å«æ‰€æœ‰å¿…è¦æ¬„ä½
            </small>
        </div>
        {% endif %}

        <div class="form-group" id="notion_database_id_group" {% if not is_edit %}hidden{% endif %}>
            <label for="notion_database_id">Notion Database ID {{ '*' if is_edit else '' }}</label>
            <input type="text" id="notion_database_id" name="notion_database_id"
                   value="{{ tenant.notion_database_id if tenant else '' }}"
                   {% if is_edit %}required{% endif %}
                   placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx">
            <small>
                {% if is_edit %}
                    Database URL ä¸­çš„ ID éƒ¨åˆ†
                {% else %}
                    è‹¥ä¸è‡ªå‹•å‰µå»ºï¼Œè«‹å¡«å…¥ç¾æœ‰è³‡æ–™åº« ID
                {% endif %}
            </small>
        </div>

        <!-- Google AI Config -->
        <h2 style="margin-top: 30px;">
            <i data-lucide="sparkles" style="width: 16px; height: 16px; margin-right: 8px; vertical-align: middle;"></i>
            Google AI è¨­å®š
        </h2>

        <div class="form-group form-check">
            <input type="checkbox" id="use_shared_google_api" name="use_shared_google_api"
                   {{ 'checked' if (not tenant or tenant.use_shared_google_api) else '' }}
                   onchange="toggleGoogleApiKey()">
            <label for="use_shared_google_api">ä½¿ç”¨å…±ç”¨ Google API Key</label>
            <small style="display: block; margin-left: 26px; color: var(--text-muted);">å»ºè­°é–‹å•Ÿï¼Œä½¿ç”¨ç³»çµ±çš„ Google Gemini API</small>
        </div>

        <div class="form-group" id="google_api_key_group" {% if not tenant or tenant.use_shared_google_api %}hidden{% endif %}>
            <label for="google_api_key">Google API Key</label>
            <input type="password" id="google_api_key" name="google_api_key"
                   placeholder="{{ 'å·²è¨­å®š (ç•™ç©ºä¿æŒä¸è®Š)' if is_edit and tenant.google_api_key else 'AIza...' }}">
            <small>ç§Ÿæˆ¶å°ˆç”¨çš„ Google Gemini API Key</small>
        </div>

        <!-- Limits -->
        <h2 style="margin-top: 30px;">
            <i data-lucide="gauge" style="width: 16px; height: 16px; margin-right: 8px; vertical-align: middle;"></i>
            ä½¿ç”¨é™åˆ¶
        </h2>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div class="form-group">
                <label for="daily_card_limit">æ¯æ—¥åç‰‡ä¸Šé™</label>
                <input type="number" id="daily_card_limit" name="daily_card_limit"
                       value="{{ tenant.daily_card_limit if tenant else 50 }}" min="1" max="1000">
                <small>æ¯å€‹ç”¨æˆ¶æ¯å¤©å¯è™•ç†çš„åç‰‡æ•¸é‡</small>
            </div>

            <div class="form-group">
                <label for="batch_size_limit">æ‰¹æ¬¡å¤§å°ä¸Šé™</label>
                <input type="number" id="batch_size_limit" name="batch_size_limit"
                       value="{{ tenant.batch_size_limit if tenant else 10 }}" min="1" max="50">
                <small>æ‰¹æ¬¡æ¨¡å¼ä¸­çš„æœ€å¤§åç‰‡æ•¸é‡</small>
            </div>
        </div>
    </form>

    <!-- Actions (outside form to avoid nesting) -->
    <div style="margin-top: 30px; display: flex; gap: 10px;">
        <button type="submit" form="tenant-form" class="btn btn-primary">
            <i data-lucide="{{ 'save' if is_edit else 'plus' }}" style="width: 16px; height: 16px;"></i>
            {{ 'å„²å­˜è®Šæ›´' if is_edit else 'å»ºç«‹ç§Ÿæˆ¶' }}
        </button>
        <a href="{{ url_for('admin.list_tenants') }}" class="btn btn-secondary">
            <i data-lucide="x" style="width: 16px; height: 16px;"></i>
            å–æ¶ˆ
        </a>

        {% if is_edit %}
        <form method="POST" action="{{ url_for('admin.delete_tenant', tenant_id=tenant.id) }}"
              style="margin-left: auto;"
              onsubmit="return confirm('ç¢ºå®šè¦åœç”¨æ­¤ç§Ÿæˆ¶å—ï¼Ÿ');">
            <button type="submit" class="btn btn-danger">
                <i data-lucide="pause-circle" style="width: 16px; height: 16px;"></i>
                åœç”¨ç§Ÿæˆ¶
            </button>
        </form>
        {% endif %}
    </div>
</div>

{% if is_edit %}
<!-- Webhook Info -->
<div class="card" style="margin-top: 20px;">
    <h2>
        <i data-lucide="link" style="width: 16px; height: 16px; margin-right: 8px; vertical-align: middle;"></i>
        Webhook è¨­å®šèªªæ˜
    </h2>
    <p style="color: var(--text-muted);">è«‹åœ¨ LINE Developers Console ä¸­è¨­å®šä»¥ä¸‹ Webhook URLï¼š</p>
    <div style="background: var(--bg-secondary); padding: 15px; border-radius: 8px; margin-top: 10px; border: 1px solid var(--border-color);">
        <code style="font-size: 1rem; color: var(--accent-purple);">https://namecard-app.zeabur.app/callback</code>
    </div>
    <p style="color: var(--text-muted); margin-top: 10px; font-size: 0.9rem;">
        <i data-lucide="info" style="width: 14px; height: 14px; margin-right: 4px; vertical-align: middle;"></i>
        æ‰€æœ‰ç§Ÿæˆ¶ä½¿ç”¨ç›¸åŒçš„ Webhook URLï¼Œç³»çµ±æœƒæ ¹æ“š Bot User ID è‡ªå‹•è­˜åˆ¥ç§Ÿæˆ¶ã€‚
    </p>
</div>
{% endif %}

<script>
function toggleGoogleApiKey() {
    const checkbox = document.getElementById('use_shared_google_api');
    const group = document.getElementById('google_api_key_group');
    group.hidden = checkbox.checked;
}

function toggleNotionApiKey() {
    const checkbox = document.getElementById('use_shared_notion_api');
    const group = document.getElementById('notion_api_key_group');
    group.hidden = checkbox.checked;
}

function toggleNotionDbInput() {
    const checkbox = document.getElementById('auto_create_notion_db');
    const group = document.getElementById('notion_database_id_group');
    const input = document.getElementById('notion_database_id');
    if (checkbox) {
        group.hidden = checkbox.checked;
        input.required = !checkbox.checked;
    }
}
</script>
{% endblock %}
